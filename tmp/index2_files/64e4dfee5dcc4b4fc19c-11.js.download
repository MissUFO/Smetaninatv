webpackJsonp([11],{141:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(2284);i.n(n);Jane.module("promo.js",function(){Daria.promo={},i(2285),i(2299),i(2302),i(2303),i(2306),i(2320)})},2284:function(e,t){},2285:function(e,t,i){i(2286),i(2296),i(2297),i(2298)},2286:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(2287);Jane.Promo={_queue:[],_promos:n.a,_nameOfShownPromo:"",availablePages:{messages:!1,message:!1},run:function(){this._queue=_.clone(this._promos),this._run()},_run:function(){var e=this,t=this.findPromo(Daria.urlParams.promo);if(t)return void this._invokeCallbackAndSetSettings(t);if(!this._isPromoSelected()&&!this._haveAllAvailablePagesBeenChecked())for(var i=!1;this._queue[0]&&!i;){var n=this._queue[0];this.shownSetting=n.name.slice(0,18)+"_s";var o=this._shouldInvokePromoCallback(n);if(!0===o)return void this._invokeCallbackAndSetSettings(n);if(o&&_.isFunction(o.then))return void o.then(function(t){return function(){i=!0,e._invokeCallbackAndSetSettings(t)}}(n),this._processNextPromo.bind(this));this._queue.shift()}},findPromo:function(e){return e?_.find(this._promos,{name:e})||null:null},showPromo:function(e){var t=this.findPromo(e);t&&this._invokeCallbackAndSetSettings(t)},_invokeCallbackAndSetSettings:function(e){this._nameOfShownPromo=e.name;try{e.callback(),this._setSettingsAfterSuccessRun(e)}catch(t){Jane.ErrorLog.sendException("promo-error."+e.name,t)}},_setSettingsAfterSuccessRun:function(e){var t=e.params,i=ns.Model.get("settings");t.showOnlyOnce&&i.setSettingOn(this.shownSetting),t.notAffectPromoDelay||i.updateSetting("promo-manager",{"last-time-show-promo":Daria.now(),"last-promo-was-name":e.name})},_processNextPromo:function(){this._queue.shift(),this._run()},_shouldInvokePromoCallback:function(e){var t=ns.Model.get("settings"),i=e.params,n=this._checkCommonPromoRules(e),o=i.ignoreStartPromoDelay||Daria.getAccountAgeInDays()>10,s=!t.getSetting(this.shownSetting),a=t.getSetting("promo-manager","json")||{},r=Number(a["last-time-show-promo"]||0),l=a["last-promo-was-name"]||"",d=Daria.now()-r>Jane.Date.WEEK;return(i.ignorePromoDelay||l===e.name)&&(d=!0),n&&d&&o&&s&&e.check()},_checkCommonPromoRules:function(e){var t=e.params;return(t.ignoreInboxMessages||Jane.Promo.has("hasInboxMessages"))&&(t.ignoreShowPromoSetting||!ns.Model.get("settings").getSetting("disable_promo"))&&(t.ignoreKCUFfilter||!Daria.IS_KCUF)&&(t.ignoreCORPfilter||!Daria.IS_CORP)&&this._isAvailablePage(ns.page.current.page)},_isPromoSelected:function(){return Boolean(this._nameOfShownPromo)},_isAvailablePage:function(e){var t=e in this.availablePages;return t&&(this.availablePages[e]=!0),t},_haveAllAvailablePagesBeenChecked:function(){var e=this;return Object.keys(this.availablePages).every(function(t){return e.availablePages[t]})}}},2287:function(e,t,i){"use strict";t.a=_.map([i(2288),i(2289),i(2290),i(2291),i(2292),i(2293),i(2294),i(2295)],"default")},2288:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="promo-close-old-themes",o=new Date(2018,7,27,0,0,0,0),s={name:n,params:{ignorePromoDelay:!0,ignoreStartPromoDelay:!1,ignoreInboxMessages:!1,ignoreKCUFfilter:!1,showOnlyOnce:!1,ignoreShowPromoSetting:!1,ignoreCORPfilter:!0},oldThemesId:["anime","art","cat","capitals","dreams","ice-cream","kindergarten","kitekat","newyear2010","origami","pushkin","red-list"],off:function(){ns.Model.get("settings").updateSetting(n,{promoClosed:!0})},getPromoSetting:function(){return ns.Model.get("settings").getSetting(n,"json")||{}},getCurrentOldThemeLocalName:function(){if(this.hasOldCurrentTheme()){var e=this.oldThemesId.filter(function(e){return e===Daria.themeId})[0];return ns.Model.get("theme-"+e).get(".data.loc-name")}},hasOldCurrentTheme:function(){return _.contains(this.oldThemesId,Daria.themeId)},getPromoText:function(){var e=Jane.Date.format("%Date_dB",o),t=this.getCurrentOldThemeLocalName();return i18n("%Close_old_themes_warning",e,t)},check:function(){return Daria.hasExperiment("84642")&&this.hasOldCurrentTheme()&&Boolean(!this.getPromoSetting().promoClosed)},callback:function(){Daria.React.promoCloseOldThemes.create(),Jane.c("Закрытие тем","показ")}};t.default=s},2289:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={name:"yandex-plus-tooltip",params:{showOnlyOnce:!0,ignoreInboxMessages:!0,ignoreKCUFfilter:!0,ignorePromoDelay:!0,ignoreStartPromoDelay:!0},check:function(){return Daria.canShowYandexPlusButton()&&!Daria.Config.haveYandexPlus},callback:function(){ns.events.trigger("daria:promo-manager:show-yandex-plus-tooltip")}}},2290:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="promo-unsubscribe-popup",o={name:n,params:{ignorePromoDelay:!0,ignoreStartPromoDelay:!0,ignoreInboxMessages:!1,ignoreKCUFfilter:!1,showOnlyOnce:!1,ignoreShowPromoSetting:!1},mSettings:null,check:function(){var e=this.getNewsletters(),t=this.getShownSetting(),i=Daria.promoNow()-t.lastTimeShown;return!!Daria.allowUnsubscribeFiltersPopup()&&(!(t.shownCount>=2||t.stopShow)&&(!(e.length<3)&&!(1===t.shownCount&&i<6048e5)))},callback:function(){Daria.React.promoUnsubscribePopup.create()},getSettingsModel:function(){return this.mSettings||(this.mSettings=ns.Model.get("settings")),this.mSettings},getNewsletters:function(){return ns.Model.get("unsubscribe-furita-newsletters").get(".newsletters")},setStopShowSetting:function(){this.getSettingsModel().updateSetting(n,{stopShow:!0})},setShownSettingDelay:function(){var e=this.getShownSetting().shownCount;this.getSettingsModel().updateSetting(n,{lastTimeShown:Daria.promoNow(),shownCount:e?++e:1})},getShownSetting:function(){return this.getSettingsModel().getSetting(n,"json")||{}},getCurrentMessage:function(){return 1===this.getShownSetting().shownCount?i18n("%Common.UnsubscribeSecondMessage"):i18n("%Common.UnsubscribeMessage")},isAvailablePage:function(){return!0}};t.default=o},2291:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(){var e={};e.userpic=null,e.popup=null,e.inited=!1,e.data={title:i18n("%Promo_check_message_title"),content:i18n("%Promo_check_message_content")},e.init=function(){if(!e.animation){e.popup||(e.promoPopupHTML=Jane.tt("promo:promo-check-message",e.data),document.body.appendChild(e.promoPopupHTML),e.$popup=$(e.promoPopupHTML),e.popup=nb.$block(".mail-MessageSnippet-Promo"));var t=e.getUserpic();(t&&t[0])!==(e.userpic&&e.userpic[0])&&(e.userpic=t)}},e.check=function(){return e.shouldShow()},e.shouldShow=function(){return Daria.UISettings.shouldShowCheckboxInsideUserpic()&&e.checkMessagesCount()},e.getUserpic=function(){var e,t=ns.Model.get("scroller-messages"),i=ns.Model.get("toolbar",{layout:ns.page.current.page}).get(".fixed")?t.FIXED_TOOLBAR_HEIGHT:0,n=t.getScrollTop()+i,o=".mail-MessageSnippet-Item_userpic_and_checkbox";return Jane.LIZA_ANTIADBLOCK&&(o+=":gt(1)"),$(o).each(function(){if(t.getNodeTop(this)>=n)return e=$(this),!1}),e||$()},e.checkMessagesCount=function(){return ns.Model.get("messages",ns.page.current.params).getCount()>0},e.checkConditionsAndOpenPopup=function(){if(!e.shouldShow())return!1;var t=e.getUserpic();t.length&&t.hasClass("ui-Animation-Pop")&&e.popup.open({where:e.userpic})},e.startAnimation=function(){e.animation||(e.animation=!0,new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Pop"),t()},0)}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Transition"),t()},0)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Pop_step1"),t()},0)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Pop_step2"),t()},250)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.removeClass("ui-Animation-Pop_step2"),t()},250)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.removeClass("ui-Animation-Pop_step1"),t()},350)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.checkConditionsAndOpenPopup(),e.userpic.removeClass("ui-Animation-Transition ui-Animation-Pop"),e.animation=!1,t()},250)})}))},e.show=function(){e.shouldShow()&&(Jane.c("промо новых чекбоксов","показ промо"),e.init(),e.startAnimation())},Daria.promoCheckMessage=e}(),t.default={name:"promo-check-message",params:{ignoreCORPfilter:!0,ignoreInboxMessages:!0,ignorePromoDelay:!0,ignoreShowPromoSetting:!0,ignoreStartPromoDelay:!0,showOnlyOnce:!0},check:Daria.promoCheckMessage.check,callback:Daria.promoCheckMessage.show}},2292:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={name:"inline-wizard-promo",params:{ignoreInboxMessages:!0,ignoreStartPromoDelay:!0,ignorePromoDelay:!0},check:function(){return Daria.InlineWizard.shouldShow()},callback:function(){Daria.InlineWizard.show()}}},2293:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={DEFAULT:Jane.Date.WEEK,AFTER_FIRST_CLOSE:1.5*Jane.Date.MONTH,AFTER_SECOND_CLOSE:3*Jane.Date.MONTH},o=[n.DEFAULT,n.AFTER_FIRST_CLOSE,n.AFTER_SECOND_CLOSE],s={lastShowTime:0,delay:n.DEFAULT,forceNextShow:!1},a=Object.defineProperties({},{DO_NOT_SHOW_PROMO:{get:function(){var e=vow.reject();return e.catch(_.noop),e}},SHOW_PROMO:{get:function(){return vow.resolve()}}}),r=!1,l=void 0;t.default={name:"push-notifications",params:{ignorePromoDelay:!0,ignoreStartPromoDelay:!0,ignoreInboxMessages:!0},check:function(){if(r)return!1;r=!0;var e=ns.Model.get("settings"),t=Boolean(e.getSetting("browser_notify_message")),i=Daria.UA,n=i.BrowserName,o=i.BrowserVersion,s="YandexBrowser"===n&&o<18.6;return t||s?a.DO_NOT_SHOW_PROMO:this.isItNotTimeToShow()?a.DO_NOT_SHOW_PROMO:this.shouldShowPromo()},shouldShowPromo:function(){var e=ns.Model.get("settings"),t=!Daria.PushManager.compatible,i=e.hasSetting("browser_notify_message");if(t||i)return a.DO_NOT_SHOW_PROMO;if("denied"===Daria.PushManager.permission())return a.DO_NOT_SHOW_PROMO;if("granted"===Daria.PushManager.permission())return e.setSettingOn("browser_notify_message"),a.DO_NOT_SHOW_PROMO;var n=ns.Model.get("push-subscriptions",{clients:"bar,yabrowser"});if(n.isValid()){var o=this.extractSubscriptions(n);return this.checkSubscriptions(o).isFulfilled()?a.SHOW_PROMO:a.DO_NOT_SHOW_PROMO}return this.getSubscriptions().then(this.checkSubscriptions)},checkSubscriptions:function(e){var t="YandexBrowser"===Daria.UA.BrowserName&&e.yabrowser,i=Daria.hasYaBar&&e.bar;return t||i?a.DO_NOT_SHOW_PROMO:a.SHOW_PROMO},isItNotTimeToShow:function(){var e=ns.Model.get("settings");return l=_.assign(s,e.getSetting("push-notifications-promo","json")),l.forceNextShow?(e.updateSetting("push-notifications-promo",{forceNextShow:!1}),!1):!(Daria.promoNow()-l.lastShowTime>l.delay&&(e.updateSetting("push-notifications-promo",{forceNextShow:!0}),1))},getSubscriptions:function(){return ns.request("push-subscriptions",{clients:"bar,yabrowser"}).then(this.extractSubscriptions)},extractSubscriptions:function(e){var t="push-subscriptions"===e.id?e.data:e&&e[0]&&e[0].data;return _.reduce(t,function(e,t){return e[t.client]=!0,e},{})},callback:function(){var e=Daria.Dialog.open({width:550,body:Jane.tt("promo:promo-default",{icon:"mail-PushNotificationsPromo_Icon",title:i18n("%Promo_PushNotifications_Title"),description:i18n("%Promo_PushNotifications_Description")}),onTarget:{side:"right",needTail:!1},additionalClass:["mail-PushNotificationsPromo","js-push-notifications-promo"],paranjaFade:!1,dontCloseOnPageGo:!0,easyclose:!1,oncancel:function(){var e=(o.indexOf(l.delay)+1)%o.length,t=o[e];ns.Model.get("settings").updateSetting("push-notifications-promo",{forceNextShow:!1,delay:t}),Jane.c("Промо браузерных пушей","Клик в крестик")},onopen:function(){$(".js-push-notifications-promo").addClass("js-show-push-notifications-promo"),ns.Model.get("settings").updateSetting("push-notifications-promo",{lastShowTime:Daria.promoNow(),delay:n.DEFAULT}),Jane.c("Промо браузерных пушей","Показ")},buttons:[{promo:!0,customClass:"mail-PushNotificationsPromo_Button",title:i18n("%Promo_PushNotifications_ButtonTitle"),name:"enable-push-notifications",onclick:function(){ns.Model.get("settings").setSettingOn("browser_notify_message"),e.close(),Jane.c("Промо браузерных пушей",'Клик в "Включить уведомления"')}}]})}}},2294:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={name:"promo-nps",params:{ignoreInboxMessages:!0},check:function(){if(!Daria.hasExperiment("59509"))return!1;var e=ns.Model.get("settings").getSetting("promo-manager","json")||{};if(e["last-promo-was-name"]===this.name){var t=e["last-time-show-promo"]||0;return Daria.now()-t>7*Jane.Date.DAY}return!0},callback:function(){function e(e){e||ns.Model.get("settings").setSettingOn(t)}var t=Jane.Promo.shownSetting;Daria.React.promoNPS.create(e)}}},2295:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=void 0,o={};o.init=function(){var e={};e.zIndex=899;var t=new window.Atom(e);this.stripe=t,this._onPageloadBinded=this._onPageload.bind(this),t.on("show",this._onShow.bind(this)),t.on("close",this._onClose.bind(this,"Закрытие промо")),t.on("click",this._onClick.bind(this)),t.on("install",this._onInstall.bind(this)),t.init()},o._onShow=function(){ns.events.on("ns-page-before-load",this._onPageloadBinded),this._asyncResizeNotifyOnShow(),this._setMetrics(["Показ"])},o._onClose=function(e){ns.events.off("ns-page-before-load",this._onPageloadBinded),this._cancelAsyncResizeNotifyOnShow(),this._asyncResizeNotifyOnHide(),this._setMetrics([e])},o._onPageload=function(e,t){"compose2"===t[1].page&&(this.stripe.hide(),this._onClose("Автоскрытие промо"))},o._onClick=function(){this._setMetrics(["Клик по промо-полоске"])},o._onInstall=function(){this._setMetrics(["Установка расширения"])},o._notifyAboutResize=function(){ns.events.trigger("daria:layout-changed"),$(window).trigger("resize"),Daria.Dialog.position()},o._setMetrics=function(e){var t=["Промо-полоска DAAS"];Jane.c(t.concat(e))},o._asyncResizeNotifyOnShow=function(){n=setTimeout(function(){o._notifyAboutResize(),n=null},300)},o._cancelAsyncResizeNotifyOnShow=function(){n&&(clearTimeout(n),n=null)},o._asyncResizeNotifyOnHide=function(){setTimeout(function(){o._notifyAboutResize()},300)},t.default={name:"yabrowser-promoline",params:{ignorePromoDelay:!0,ignoreInboxMessages:!0,ignoreShowPromoSetting:!0,ignoreKCUFfilter:!0},check:function(){return"compose2"!==ns.page.current.page&&Daria.is2pane()&&["RUS","TUR"].indexOf(Daria.Config.product)>-1},callback:function(){Daria.Libs("Atom",o.init.bind(o))}}},2296:function(e,t){!function(e,t,i){var n=null,o=function(t){return n[t]=$.isFunction(n[t])?n[t](e):n[t],n[t]};n=o.cache={},o.add=function(e,t,i,s){return(void 0===n[e]||s)&&(n[e]=t),i&&o(e)},t.has=o}(this,Jane.Promo),Jane.Promo.has.add("hasInboxMessages",function(){return Daria.messages.everHadMessages()})},2297:function(e,t){!function(){var e={shouldShow:function(){var e=ns.Model.get("settings");return"welcome"===Daria.urlParams.wizard||!Daria.Config.NO_SETTINGS&&(!Daria.IS_CORP&&!Daria.Config.workspace&&(!!Daria.isNewAccount()&&(!e.isSet("welcome_wizard_date")&&!(["ru","uk","en","tr"].indexOf(Daria.Config.locale)<0))))},getSteps:function(){return["welcome-wizard-theme-step","welcome-wizard-mobile-app-step","welcome-wizard-collectors-step"]},show:function(){var e=ns.Model.get("settings");if(this.vPopup&&this.vPopup.isValid())return void this.close();this._getWizardState().on("daria:wizard:complete",this.close.bind(this)),this.vPopup=ns.View.create("welcome-wizard-popup"),this.vPopup.open({class:"mail-WelcomeWizardPopup",close:!1,height:500,width:770,where:document,autoclose:!1,autofocus:!1}),e.setSettings({welcome_wizard_date:Daria.now()})},close:function(){this._getWizardState().off("daria:wizard:complete"),this.vPopup&&this.vPopup.isValid()&&(this.vPopup.close(),this.vPopup=null)},_getWizardState:function(){return ns.Model.get("wizard-state",{wizard_name:"welcome"})}};Daria.WelcomeWizard=e}()},2298:function(e,t){Daria.InlineWizard={interval:500,max:5,currentStep:1,footerHeight:50,height:480,minHeight:5,labelHeight:49,wizardView:null,stepsViewsNames:["inline-wizard-mobile-app-step"],start:function(e){this.$node=$(e),this.writeStepNumber(1),ns.Model.get("settings").setSettingOff("inline-wizard-close")},writeStepNumber:function(e){this.$node.find(".js-inline-wizard-step-"+e+" .js-wizard-step__number").text(i18n("%Wizard_step",e<=this.max?e:this.max,this.max))},removeWizard:function(){var e=this.$node.find(".js-inline-wizard-parent");e.css({height:0,minHeight:0}),e.on("webkitTransitionEnd oTransitionEnd transitionend mozTransitionEnd",function(){e.remove()})},end:function(){this.removeWizard()},getPageHeight:function(e){return this.$node.find(".js-inline-wizard-parent").offset().top+e.height()-this.footerHeight},onTransitionEnd:function(e,t){!Modernizr.cssanimations||Modernizr.opera&&!Modernizr.webkit?t():e.one("webkitTransitionEnd oTransitionEnd transitionend mozTransitionEnd",t)},open:function(){var e=this.$node.find(".js-inline-wizard-parent"),t=this.$node.find(".js-inline-wizard-current"),i=this.getPageHeight(t);e.addClass("inline-wizard-wrapper-small mail-InlineWizard-Wrapper_small").addClass("inline-wizard-wrapper-open mail-InlineWizard-Wrapper_open").css({height:this.minHeight,minHeight:this.minHeight}),Daria.forceNodeReflow(e[0]),e.removeClass("inline-wizard-wrapper-small mail-InlineWizard-Wrapper_small"),this.onTransitionEnd(e,this.afterOpenAnimation.bind(this,e,i))},afterOpenAnimation:function(e,t){Daria.forceNodeReflow(e[0]),this.$node.find(".js-inline-wizard-label").addClass("g-hidden"),this.$node.find(".js-inline-wizard-steps-wrapper").removeClass("g-hidden"),e.css({height:this.height,minHeight:this.height}),$("body").stop().animate({scrollTop:t},this.interval),ns.events.trigger("wizard-open",this.getCurrentStep())},openBeforeRender:function(){var e=this.$node.find(".js-inline-wizard-steps-wrapper");this.$node.find(".js-inline-wizard-label").addClass("g-hidden"),e.removeClass("g-hidden")},getCurrentStep:function(){return parseInt(this.currentStep,10)},close:function(e){ns.Model.get("settings").setSettingOn("inline-wizard-close");var t=this.$node&&this.$node.find(".js-inline-wizard-parent");if(!t||!t.length)return this.clearWizardView(),vow.resolve();if(e)return this.afterCloseAnimation(t),vow.resolve();t.css({height:t.outerHeight()});var i=this.$node.find(".js-inline-wizard-parent").offset().top-this.footerHeight;t.stop(),t.addClass("inline-wizard-wrapper-close mail-InlineWizard-Wrapper_close"),t.css({height:0,minHeight:0});var n=this;return new vow.Promise(function(e){n.onTransitionEnd(t,function(){n.afterCloseAnimation(t,i),e()})})},afterCloseAnimation:function(e){this.$node.find(".js-inline-wizard-label").removeClass("g-hidden"),this.$node.find(".js-inline-wizard-steps-wrapper").addClass("g-hidden"),e.css({height:0,minHeight:0}),this.clearWizardView()},forceClose:function(){var e=this.$node.find(".js-inline-wizard-parent");e.addClass("mail-InlineWizard-Steps_no-transition").css({height:0,minHeight:0}),Daria.forceNodeReflow(e[0]),e.removeClass("mail-InlineWizard-Steps_no-transition"),this.$node.find(".js-inline-wizard-label").removeClass("g-hidden"),this.$node.find(".js-inline-wizard-steps-wrapper").addClass("g-hidden")},step:function(e){if(this.noScrollWhileIDo)return!1;this.noScrollWhileIDo=!0;var t=this.$node.find(".js-inline-wizard-parent"),i=t.outerWidth()+2,n=this.$node.find(".js-inline-wizard-scrolling-element");switch(e){case"next":this.nextStep(t,n,i);break;case"prev":this.prevStep(t,n,i);break;case"check":this.checkStep(t,n,i)}},changeStep:function(e){this.currentStep=e,ns.Model.get("settings").setSettings({"inline-wizard-step":e}),ns.events.trigger("wizard-step-change",this.getCurrentStep())},nextStep:function(e,t,i){var n,o=this;if(parseInt(this.currentStep,10)===o.max)return void o.step("check");n=parseInt(this.currentStep,10)+1,o.writeStepNumber(n),o.metrika(n-1,"Далее"),2===n&&(o.$node.find(".b-notification_error").addClass("g-hidden"),ns.events.trigger("daria:vWizardLabels:addLabels")),t.css({marginLeft:parseInt(t.css("margin-left"),10)-i}),this.onTransitionEnd(e,this.onTransitionEndStep.bind(this,n)),o.changeStep(n),this.metrika(n,"Показ")},prevStep:function(e,t,i){var n,o=this;n=parseInt(this.currentStep,10)-1,o.writeStepNumber(n),2===n&&o.$node.find(".b-notification_error").addClass("g-hidden"),t.css({marginLeft:parseInt(t.css("margin-left"),10)+i}),this.onTransitionEnd(e,this.onTransitionEndStep.bind(this,n)),o.changeStep(n),this.metrika(n,"Показ")},onTransitionEndStep:function(e){this.$node.find(".js-inline-wizard-current").removeClass("js-inline-wizard-current"),this.$node.find(".js-inline-wizard-step-"+e).addClass("js-inline-wizard-current"),this.noScrollWhileIDo=!1},checkStep:function(e,t,i){var n,o=this;n=parseInt(this.currentStep,10)||1,o.writeStepNumber(n),t.addClass("mail-InlineWizard-Steps_no-transition").css({marginLeft:-i*(n-1)}),Daria.forceNodeReflow(t[0]),t.removeClass("mail-InlineWizard-Steps_no-transition"),o.$node.find(".js-inline-wizard-current").removeClass("js-inline-wizard-current"),o.$node.find(".js-inline-wizard-step-"+n).addClass("js-inline-wizard-current"),o.noScrollWhileIDo=!1,o.changeStep(n)},clearWizardView:function(){this.wizardView&&this.wizardView.destroy(),this.wizardView=null},metrika:function(e,t){if(("string"==typeof e||Array.isArray(e))&&(t=e,e=void 0),!this._metrikaCategory){var i,n=Daria.now()-ns.Model.get("account-information").getData().reg_date;i=n<=3*Jane.Date.DAY?"Показы новым пользователям":"Показы старым пользователям",this._metrikaCategory=["Новый Визард",i]}var o=this._metrikaCategory;!0===e&&(e=this.getCurrentStep()),e&&(o=o.concat(this._metrikaSteps[e])),o=o.concat(t),Jane.c(o)},_metrikaSteps:["","Метки","Сборщики","Информация об отправителе","Темы","Валидация","Done"]},Daria.InlineWizard.hasAvailableSteps=function(e){return Object.keys(Daria.InlineWizard.getAvailableSteps(e)).length>0},Daria.InlineWizard.getAvailableSteps=function(e){var t={};return this.stepsViewsNames.forEach(function(i){var n,o=ns.View.info(i);o.shouldShow(e)&&(n=o.getLayout(e),t[n.name]=n.childViews)}),t},Daria.InlineWizard.shouldShow=function(){var e=this,t=ns.page.current.params;return!(!Daria.is2pane()||Daria.IS_KCUF||Daria.IS_CORP)&&ns.request(["user-apps-activity"]).then(function(){return e.hasAvailableSteps(t)?vow.resolve():vow.reject()})},Daria.InlineWizard._renderWizard=function(){var e={_yateModule:"promo"};this.wizardView&&this.wizardView.destroy&&this.wizardView.destroy(),this.wizardView=ns.View.create("inline-wizard"),new ns.Update(this.wizardView,ns.layout.page("wizard-inline",e),e,{execFlag:ns.U.EXEC.PARALLEL}).render()},Daria.InlineWizard._showWizard=function(){this.wizardView.showOnPage(),this.openBeforeRender()},Daria.InlineWizard.show=function(){var e=this;Jane.Services.runModules(["setup.js"],function(){e._renderWizard()})}},2299:function(e,t,i){i(2300),i(2301)},2300:function(e,t){ns.action.define("wizard.open-inline-block",function(){Daria.InlineWizard.open(null,1)}),ns.action.define("wizard.close-inline-block",function(){Daria.InlineWizard.close()}),ns.action.define("wizard.close-inline-wizard",function(){Daria.InlineWizard.close()}),ns.action.define("wizard.step-inline-block",function(e,t){Daria.InlineWizard.step(t.step)}),ns.action.define("wizard.end-inline-block",function(){Daria.InlineWizard.end()})},2301:function(e,t){ns.action.define("user-feedback.send",function(){ns.events.trigger("daria:vUserFeedbackReport:send")}),ns.action.define("user-feedback.next",function(e,t,i,n){var o={event:n,params:t};ns.events.trigger("daria:vUserFeedbackReport:changeStep",Number(o.params.step)+1)}),ns.action.define("user-feedback.prev",function(e,t,i,n){var o={event:n,params:t};ns.events.trigger("daria:vUserFeedbackReport:changeStep",Number(o.params.step)-1)})},2302:function(e,t){ns.layout.define("welcome-wizard-popup",{"welcome-wizard-popup":{"welcome-wizard":function(){var e=ns.Model.get("wizard-state",{wizard_name:"welcome"}),t=Daria.WelcomeWizard.getSteps(),i={"welcome-wizard-theme-step":{"welcome-wizard-themes-selector-wrapper":{"themes-selector-box@":function(){var e={};return ns.Model.get("themes").get(".themes.*.settings").forEach(function(t){e[t]={}}),{"themes-selector":e}}}}};return e.setSteps(t),_.zipObject(t,t.map(function(e){return i[e]||{}}))}}}),ns.layout.define("wizard-inline",{"inline-wizard":{"inline-wizard-box@":function(e){return Daria.InlineWizard.getAvailableSteps(e)}}}),ns.layout.define("user-feedback",{"user-feedback":{"user-feedback-box@":function(e){if(e.report)return{"user-feedback-report":{}}}}}),ns.layout.define("promo-mobile-app-popup",{"promo-mobile-app-popup":{"promo-mobile-app-popup-body":{}}})},2303:function(e,t,i){i(2304),i(2305)},2304:function(e,t){ns.Model.define("wizard-state",{params:{wizard_name:null},events:{"ns-model-init":"_onInit"},methods:{_activeStepIndex:-1,_onInit:function(){var e={activeStep:null,isTransitionLocked:!1,steps:[],stepShownFlags:{},firstLoad:!0};e.nonActiveSteps=["welcome-wizard-intro-step","welcome-wizard-done-step"],this.setData(e)},setSteps:function(e){this.set(".steps",e)},getSteps:function(){return this.get(".steps")},reset:function(){var e=this.get(".steps");this.set(".stepShownFlags",_.zipObject(e,e.map(function(){return!1})),{silent:!0}),this._setActiveStep(this.get(".steps")[0])},setStep:function(e){return!this.get(".isTransitionLocked")&&this._setActiveStep(e)},getStepWasShown:function(e){return this.get(".stepShownFlags."+e)},_setActiveStep:function(e){var t=this.get(".steps"),i=t.indexOf(e),n=this.getActiveStep();return!(i<0)&&(this._activeStepIndex=i,this.set(".stepShownFlags."+e,!0,{silent:!0}),this.set(".prevActiveStep",n,{silent:!0}),this.set(".activeStep",e),!0)},goToPrevStep:function(){var e=this.getPrevStep();return e?(this.setStep(e),e):null},goToNextStep:function(){var e=this.getNextStep();return e?(this.setStep(e),e):(this.complete(),null)},isLastStep:function(e){var t=this.get(".steps");return t.indexOf(e)===t.length-1},complete:function(){this.trigger("daria:wizard:complete")},getPrevStep:function(){return this.get(".steps")[this._activeStepIndex-1]},getNextStep:function(){return this.get(".steps")[this._activeStepIndex+1]},getActiveStep:function(){return this.get(".activeStep")},getPrevActiveStep:function(){return this.get(".prevActiveStep")},isTransitionLocked:function(){return this.get(".isTransitionLocked")},lockTransition:function(){this.set(".isTransitionLocked",!0)},unlockTransition:function(){this.set(".isTransitionLocked",!1)},isFirstLoad:function(){return this.get(".firstLoad")},firstLoadDone:function(){this.set(".firstLoad",!1,{silent:!0})}}},ns.ModelStatic)},2305:function(e,t){!function(){ns.Model.define("inline-wizard-state",{events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData({allViewsHide:!1,allViewsClose:!1,closeWithAnimation:!0},{silent:!0})}}},ns.ModelStatic)}()},2306:function(e,t,i){i(2307),i(2308),i(2309),i(2310),i(2311),i(2312),i(2313),i(2314),i(2315),i(2316),i(2317),i(2318),i(2319)},2307:function(e,t){ns.View.define("user-feedback",{events:{"daria:vUserFeedback:update@show":"onUpdate"},yateModule:"promo",methods:{onUpdate:function(e,t){return this.updateWithParams(t)},updateWithParams:function(e){var t=no.extend({},this.params,e);return this.updateByLayout("user-feedback",t,{execFlag:ns.U.EXEC.PARALLEL})}}})},2308:function(e,t){!function(e,t){function i(e){var i=ns.Model.get("compose-message"),n=e.pgUser?"[NEWFORM-PG] ":"[NEWFORM] ",o={to:s,subj:n+e.selectValue};o.send=e.message+"\n\n----\nLogin: "+t.login+"\nBrowser: "+navigator.userAgent+"\nAddress: "+t.Config.userIP+"\nReferer: new form",e.attachmentIds&&(o.att_ids=e.attachmentIds),e.messageId&&(o.ids=e.messageId),o["recipients-diff"]={added:[],removed:[]},i.setData(o)}function n(){t.Dialog.$dialog&&6===t.Dialog.$dialog.data("step")&&t.Dialog.close()}function o(e,t){t=t||"";for(var i=atob(e),n=i.length,o=Math.ceil(n/1024),s=new Array(o),a=0;a<o;++a){for(var r=1024*a,l=Math.min(r+1024,n),d=new Array(l-r),c=r,h=0;c<l;++h,++c)d[h]=i[c].charCodeAt(0);s[a]=new Uint8Array(d)}return new Blob(s,{type:t})}var s="mail@support.yandex.ru";ns.View.define("user-feedback-report",{events:{"ns-view-htmlinit":"onhtmlinit","ns-view-htmldestroy":"onhtmldestroy","daria:vUserFeedbackReport:changeStep":"onChangeStep","daria:vUserFeedbackReport:send":"send","keyup .js-kbd-report":"validationForm","change .js-feedback-file":"addFile","click .js-feedback-remove-file":"removeFile","click .js-feedback-take-screenshot":"takeScreenshot","click .js-feedback-remove-screenshot":"removeScreenshot"},"params+":{canAttachEml:null,canTakeScreenshot:null,text:null,pgUser:null,onlyReport:null},yateModule:"promo",methods:{onhtmlinit:function(){var e=this,t=this.$node;this._attachments=[],this.$node=t,this.$form=t.find(".js-feedback-form"),this.$steps=t.find(".js-feedback-step"),this.$files=t.find(".js-feedback-attachments"),this.$filesView=t.find(".js-feedback-files"),this.$screenshotContainer=t.find(".js-feedback-screenshot"),this.$inputs=t.find(".js-kbd-report"),this.$screenshotView=t.find(".js-feedback-attach-screen"),this.$screenshotLoader=t.find(".js-feedback-screenshot-loader"),this.$select=t.find(".js-feedback-change-theme-select"),this.$fileInpTemplate=t.find(".js-feedback-file").clone(!0),nb.init(this.node),this.nbNextButtons=[],t.find(".js-feedback-next").each(function(){e.nbNextButtons.push(nb.block(this))}),this.nbChangeThemesSelect=nb.$block(".js-feedback-change-theme-select",t),this.nbChangeThemesSelect.on("nb-changed",e.validationForm.bind(e))},onhtmldestroy:function(){nb.destroy(this.$select)},validationForm:function(e){var t=this.nbChangeThemesSelect.getState().value;"nb-changed"!==e&&(this._message=e.target.value,this.$inputs.not(e.target).val(this._message)),this._message&&"changethemes"!==t?(this.nbNextButtons[0].enable(),this.nbNextButtons[2].enable()):(this.nbNextButtons[0].disable(),this.nbNextButtons[2].disable())},takeScreenshot:function(){e.c("ФОС","Шаг 5","Cнимок экрана")},removeScreenshot:function(){delete this.screenshotDataURL,this.$screenshotContainer.empty(),this.$screenshotView.removeClass("feedback-attach-not-empty")},redrawFiles:function(){for(var t=[],i=!1,n=0;n<this._attachments.length;++n){var o=this._attachments[n],s="";if(o.info.file)s=o.info.file.name;else{s=/[^\\\/]*$/.exec($(o.info.input).val())[0]}var a="",r=/^(.*)(\.[^.]*)$/.exec(s);r&&(s=r[1],a=r[2]),t.push({name:s,ext:a,overlimit:o.isOverLimit,id:n}),i=o.isOverLimit||i}this.$filesView.html(e.tt("promo:user-feedback-report-attachments",{atts:t,"overlimit-mode":i})),$(".js-feedback-attach-files").toggleClass("feedback-attach-not-empty",this._attachments.length>0)},addFile:function(i){var n=this;e.c("ФОС","Шаг 5","Загрузить файл"),e.Services.run("#compose",function(){var e=i.target,o=$(e).parent(),s=ns.Model.get("compose-message");if(Modernizr.filereader){$.each(e.files,function(){n._attachments.push(new t.Attachment2({file:this,type:"simple",mComposeMessage:s}))});var a=0;n._attachments.forEach(function(e){a+e.info.file.size>26214400?e.isOverLimit=!0:(e.isOverLimit=!1,a+=e.info.file.size)}),$(e).remove()}else{var r=new t.Attachment2({input:e,type:"simple",mComposeMessage:s});r.isOverLimit=!1,n._attachments.push(r)}o.prepend(n.$fileInpTemplate.clone(!0)),n.redrawFiles()})},removeFile:function(e){var t=$(e.target).data("fileid");this._attachments.splice(t,1),this.redrawFiles()},send:function(){t.Dialog.$dialog.addClass("feedback-no-header"),this.setStep("sending");var e=[];this._attachments.forEach(function(t){t.isOverLimit||e.push(t.upload())}),this.screenshotDataURL&&e.push(this.uploadScreenshot()),$.when.apply(null,e).done(this._sendMessage.bind(this))},_sendMessage:function(){var o=this;e.Services.run("#compose",function(){ns.request(["compose-message"]).then(function(){var e=ns.Model.get("compose-message");i({message:o._message,text:o.params.text,selectValue:o.nbChangeThemesSelect.getState().text,messageId:o.$node.find(".js-attach-eml input").is(":checked")?ns.page.current.params.ids:null,attachmentIds:$.map(o._attachments,function(e){return e.info.att_id}),pgUser:o.params.pgUser}),e.send({force:!0}).then(function(){o.setStep("done"),t.Statusline.hide(),setTimeout(n,15e3)})})})},setStep:function(i){isNaN(i)||(t.Dialog.$dialog.data("step",i+3),e.c("ФОС","Шаг "+(i+3),"Показ шага")),"done"===i&&e.c("ФОС","Шаг 7","Показ шага"),this.$steps.addClass("g-hidden"),this.$node.find(".js-feedback-step-"+i).removeClass("g-hidden")},uploadScreenshot:function(){var i=this,n=$.Deferred();return e.Services.run("#compose",function(){var e=i.screenshotDataURL.split(","),s=new t.Attachment2({name:"screenshot.png",type:"simple",file:o(e[1],"image/png"),mComposeMessage:ns.Model.get("compose-message")});i._attachments.push(s),s.upload().always(function(){n.resolve()})}),n},onChangeStep:function(e,t){this.setStep(t)}}})}(Jane,Daria)},2309:function(e,t){ns.View.define("wizard-step-mixin",{methods:{stepName:null,isShown:!1,_goToNextStepDelay:1e3,getWizardStateModel:function(){return ns.Model.get("wizard-state",this.params)},initWizardStep:function(){this.onStepAnimationStartBinded=this.onStepAnimationStart.bind(this),this.onStepAnimationEndBinded=this.onStepAnimationEnd.bind(this),this.onDotNavigationBinded=this.onDotNavigation.bind(this),this.onPopupClosedBinded=this.onPopupClosed.bind(this)},startWizardStep:function(){this.getWizardStateModel().on("daria:WelcomeWizard:stepAnimationStart",this.onStepAnimationStartBinded),this.getWizardStateModel().on("daria:WelcomeWizard:stepAnimationEnd",this.onStepAnimationEndBinded),this.getWizardStateModel().on("daria:WelcomeWizard:dotNavigation",this.onDotNavigationBinded),ns.events.on("daria:WelcomeWizard:closed",this.onPopupClosedBinded)},stopWizardStep:function(){this._clearChangeStepTimer(),this.getWizardStateModel().off("daria:WelcomeWizard:stepAnimationStart",this.onStepAnimationStartBinded),this.getWizardStateModel().off("daria:WelcomeWizard:stepAnimationEnd",this.onStepAnimationEndBinded),this.getWizardStateModel().off("daria:WelcomeWizard:dotNavigation",this.onDotNavigationBinded),ns.events.off("daria:WelcomeWizard:closed",this.onPopupClosedBinded)},onStepAnimationStart:function(e,t,i){if(this.stepName===t){if(!this.isShown)return;this.isShown=!1,this.onStepHideStart(!1)}if(this.stepName===i){if(this.isShown)return;this.isShown=!0,this.onStepShowStart()}},onStepAnimationEnd:function(e,t,i){this.stepName===t&&this.onStepHidden(!1),this.stepName===i&&this.onStepShown()},goToPrevStep:function(){this._clearChangeStepTimer(),this.getWizardStateModel().goToPrevStep()},goToNextStep:function(e){this._clearChangeStepTimer(),this._changeStepTimer=setTimeout(function(){this._clearChangeStepTimer(),this.getWizardStateModel().goToNextStep()}.bind(this),e||0)},goToNextStepWithDelay:function(){this.goToNextStep(this._goToNextStepDelay)},disableStep:function(){this.$fieldset||(this.$fieldset=this.$node.closest("fieldset")),this.$fieldset.attr("disabled",!0);var e=nb.$block(this.$fieldset.find("button[type=submit]"));e&&e.disable()},enableStep:function(){this.$fieldset||(this.$fieldset=this.$node.closest("fieldset")),this.$fieldset.attr("disabled",!1);var e=nb.$block(this.$fieldset.find("button[type=submit]"));e&&e.enable()},onStepShowStart:function(){},onStepShown:function(){},onStepHideStart:function(e){},onStepHidden:function(e){},isLastStep:function(){return this.getWizardStateModel().isLastStep(this.stepName)},isActive:function(){return this.isShown},onPopupClosed:function(){this.onStepHideStart(!0),this.onStepHidden(!0),this._clearChangeStepTimer()},onDotNavigation:function(e,t){this.stepName===t&&this.onStepSkipped()},onStepSkipped:function(){},getContinueButtonText:function(e){return this.isLastStep()?i18n("%Promo_НачатьРаботу"):e},toggleEnabled:function(e,t){t?e.enable():e.disable()},_clearChangeStepTimer:function(){this._changeStepTimer&&(clearTimeout(this._changeStepTimer),this._changeStepTimer=null)}}})},2310:function(e,t){ns.View.define("welcome-wizard-intro-step",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click .js-go-to-next-step":"onGoToNextStepClick"},params:function(){return{wizard_name:"welcome"}},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-intro-step",onShow:function(){this.startWizardStep()},onHide:function(){this.stopWizardStep()},onGoToNextStepClick:function(){this.goToNextStep()}}},"wizard-step-mixin")},2311:function(e,t){ns.View.define("welcome-wizard-collectors-step",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-htmldestroy":"onHtmlDestroy","click .js-go-to-next-step":"onGoToNextStepClick","submit .js-collector-create-form":"onCollectorCreateFormSubmit","onCollectorCreateDidFail.welcome-wizard-collectors-step@show":"onCollectorCreateFail","onCollectorCreateSuccess.welcome-wizard-collectors-step@show":"onCollectorCreateSuccess","daria:CollectorSettings:form-type-changed@show":"onFormTypeChanged"},models:{"collector-texts":!1,"collector-create-form-state":{"ns-model-changed":"keepValid","ns-model-changed.state":"onCollectorCreateFormStateChangedState","ns-model-changed.advanced":"onChangedAdvanced"}},params:function(){return{wizard_name:"welcome"}},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-collectors-step",onHtmlInit:function(){this.$collectorCreateForm=this.$node.find(".js-collector-create-form"),this.$collectorCreateFormFieldset=this.$node.find(".js-collector-create-form-fieldset"),this.settings=new Daria.Collectors.Settings(this.$collectorCreateForm),this.$collectorCreateButtons=this.$node.find(".js-collector-create-buttons"),this.$collectorCreateStatusLoading=this.$node.find(".js-collector-create-status-loading"),this.$collectorCreateStatusDone=this.$node.find(".js-collector-create-status-done"),this.nbCollectorCreateButton=nb.$block(".js-collector-create",this.node)},onHtmlDestroy:function(){this.settings&&this.settings.destroy()},onShow:function(){this.startWizardStep(),this.onCollectorCreateFormStateChangedState(),this.getModel("collector-create-form-state").resetState()},onHide:function(){this.stopWizardStep()},onStepShowStart:function(){this.setCollectorsMetrics(["Показ"]),this.onCollectorCreateFormStateChangedState()},onStepHidden:function(e){this.disableStep(),this.disableStepForm(),e&&this.isActive()&&this.setCollectorsMetrics(["Закрыть"])},onStepSkipped:function(){this.setCollectorsMetrics(["Пропустить"])},disableStepForm:function(){this.$collectorCreateFormFieldset.attr("disabled",!0)},enableStepForm:function(){this.$collectorCreateFormFieldset.attr("disabled",!1)},onGoToNextStepClick:function(e){e.preventDefault();var t=this.getModel("collector-create-form-state"),i=Daria.EnumCollectorCreateFormState.SUCCESS;(!this.isLastStep()||t.getState()!==i&&t.canRetry())&&this.setCollectorsMetrics(["Пропустить"]),this.goToNextStep()},onCollectorCreateFormSubmit:function(e){e.preventDefault(),this.createCollector(this.$collectorCreateForm)},createCollector:function(e){var t=this.id;if(e.data("settings").validate()){var i=this;ns.request(["collectors"]).then(function(n){n[0].getCount()<10?(Daria.Collectors.Creator.run(e,t),i.setCollectorsMetrics(["Подключить ящик"]),i.onCollectorCreateSendRequest()):Daria.Dialog.notice({title:i18n("%Setup_Collector_Dialog_Create_title"),body:i18n("%Setup_Collector_Dialog_Create_body")})}).fail(this.onCollectorCreateFail,this)}},onCollectorCreateSendRequest:function(){this.getModel("collector-create-form-state").onRequesting()},onCollectorCreateFail:function(){var e=this.getModel("collector-create-form-state");e.onFailure(),e.canRetry()||e.onTriesExceeded()},onCollectorCreateFormStateChangedState:function(){var e=this.getModel("collector-create-form-state"),t=e.getState(),i=Daria.EnumCollectorCreateFormState;switch(t){case i.INITIAL:this.$collectorCreateButtons.toggleClass("is-hidden",!1),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.enableStep(),this.enableStepForm();break;case i.FAILURE:this.$collectorCreateButtons.toggleClass("is-hidden",!1),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.setCollectorsMetrics(["Ошибка при подключении"]),this.enableStep(),this.enableStepForm();break;case i.TRIES_EXCEEDED:this.$collectorCreateButtons.toggleClass("is-hidden",!1),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.enableStep(),this.disableStepForm(),this.toggleEnabled(this.nbCollectorCreateButton,!1),_.defer(Daria.Collectors.Checker.onCollectorCheckTriesExceeded,this.$collectorCreateForm[0],"create");break;case i.REQUESTING:this.$collectorCreateButtons.toggleClass("is-hidden",!0),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!1),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.enableStep(),this.disableStepForm();break;case i.SUCCESS:this.$collectorCreateButtons.toggleClass("is-hidden",!0),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!1),this.enableStep(),this.disableStepForm(),e.shouldGoNextWithDelay()&&!this.isLastStep()&&(e.unsetShouldGoNextWithDelay(),this.goToNextStepWithDelay())}},onCollectorCreateSuccess:function(){this.getModel("collector-create-form-state").onSuccess(),this.setCollectorsMetrics(["Ящик успешно подключен"])},onFormTypeChanged:function(e,t){this.getModel("collector-create-form-state").setIfChanged(".advanced",t)},onChangedAdvanced:function(){this.setCollectorsMetrics(["Показ"])},setCollectorsMetrics:function(e){var t=["Приветственный визард","Сборщики"];this.getModel("collector-create-form-state").isAdvancedForm()?t.push("Все письма вместе (не знаем домен)"):t.push("Все письма вместе (знаем домен)"),Jane.c(t.concat(e))}}},"wizard-step-mixin")},2312:function(e,t){ns.View.define("welcome-wizard-done-step",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click .js-go-to-prev-step":"onGoToPrevStepClick"},params:function(){return{wizard_name:"welcome"}},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-done-step",onShow:function(){this.startWizardStep()},onHide:function(){this.stopWizardStep()},onGoToPrevStepClick:function(){this.goToPrevStep()}}},"wizard-step-mixin")},2313:function(e,t){ns.View.edefine("welcome-wizard-mobile-app-step",{models:{"promo-mobile-app-state":"onStateChanged",userphones:!1},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-get-mobile-app-link":"sendMobileAppLink","click .js-get-mobile-app-link-skip":"skipStep","click .js-get-mobile-app-link-continue":"continueWizard","click .js-close-wizard":"closeWizard"},params:function(){return{wizard_name:"welcome",promo:"welcome-wizard"}},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-mobile-app-step",onHtmlInit:function(){this.initPromoMobileAppMixin()},onShow:function(){this.startWizardStep()},onStepShown:function(){this._loadState(),this.setMobileMetrics(["Показ"]),this.enableStep()},onStepHidden:function(e){this.getState().resetErrorMessages(),this._loadState(),this.disableStep(),e&&this.isActive()&&this.setMobileMetrics(["Закрыть"])},onStepSkipped:function(){this.setMobileMetrics(["Пропустить"])},onHide:function(){this.stopWizardStep()},disableStepForm:function(){this.toggleEnabled(this.nbPhoneNumber,!1),this.toggleEnabled(this.nbGetAppLinkButton,!1)},enableStepForm:function(){this.toggleEnabled(this.nbPhoneNumber,!0),this.toggleEnabled(this.nbGetAppLinkButton,!0)},_loadState:function(){var e=this.getState(),t=e.isEnterPhoneState(),i=e.isInvalidPhoneNumberState(),n=e.isSendingState(),o=e.isSendFailedState(),s=e.isSendSuccessState(),a=t&&e.canRetry(),r=i,l=!r&&o&&e.canRetry(),d=o&&!e.canRetry(),c=this.$node;c.find(".js-buttons-send").toggleClass("is-hidden",!a),c.find(".js-error-message-phone-number").toggleClass("is-invisible",!r),c.find(".js-buttons-sending").toggleClass("is-hidden",!n),c.find(".js-error-message-send-failed").toggleClass("is-invisible",!l),c.find(".js-buttons-continue").toggleClass("is-hidden",!d),c.find(".js-send-success").toggleClass("is-hidden",!s),a?this.enableStepForm():this.disableStepForm(),(t||i)&&!this.nbPhoneNumber.getValue()&&this.isActive()&&_.defer(function(){this.nbPhoneNumber.focus()}.bind(this)),s&&(ns.Model.get("settings").setSettings({"promo-mobile_sms-send":!0,"promo-mobile_sms-send_date":Daria.now()}),e.shouldGoNextWithDelay()&&!this.isLastStep()&&(e.unsetShouldGoNextWithDelay(),this.goToNextStepWithDelay()))},sendMobileAppLink:function(){var e=this.getState();if(!e.canTrySendAppLink()||!e.canRetry())return void(e.isInvalidPhoneNumberState()&&this.nbPhoneNumber.focus());var t={app:"mail-start-wizard-liza"},i=this._getPhoneNumber();if(i){if(!Jane.FormValidation.checkPhoneNumber(i))return e.setInvalidPhoneNumberState(),void this.nbPhoneNumber.focus();t.phone_full=i,this.setMobileMetrics(["Получить ссылку","Номер введен вручную успешно"])}else{var n=this.getPhoneParams();if(!n)return e.setInvalidPhoneNumberState(),void this.nbPhoneNumber.focus();_.assign(t,n),this.setMobileMetrics(["Получить ссылку","Номер введен при регистрации (автозаполнение)"])}e.startSending();var o=this;ns.forcedRequest(["get-link-app"],t).then(function(t){var i=t[0].getData();if(i&&"ok"===i.result)return e.onSuccess(),void o.setMobileMetrics(["Получить ссылку","Сообщение отправлено"]);e.onSendFailed(),o.setMobileMetrics(["Получить ссылку","Ошибка при отправке"])}).fail(function(){e.onSendFailed(),o.setMobileMetrics(["Получить ссылку","Ошибка при отправке"])})},applyPhoneNumberFormat:function(e){return this.cleanPhoneNumber(e)},skipStep:function(e){e.preventDefault(),this.setMobileMetrics(["Пропустить"]),this.goToNextStep()},continueWizard:function(e){e.preventDefault(),this.isLastStep()||this.setMobileMetrics(["Пропустить"]),this.goToNextStep()},closeWizard:function(e){e.preventDefault(),this.goToNextStep()},setMobileMetrics:function(e){var t=["Приветственный визард","Мобильная почта"];Jane.c(t.concat(e))}}},"wizard-step-mixin","promo-mobile-app-mixin",ns.View)},2314:function(e,t){ns.View.define("welcome-wizard-theme-step",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-submit":"onSubmitClick","click .js-skip":"onSkipClick","mousedown .js-theme-thumbnail":"onThemeThumbClick"},models:{settings:{"ns-model-changed":"onSettingsChanged"}},params:function(e){return _.extend({wizard_name:"welcome"},e)},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-theme-step",onHtmlInit:function(){this._defaults||(this._defaults=this._getCurrentSettings())},onShow:function(){this.startWizardStep()},onStepShown:function(){this.setThemeMetrics(["Показ"])},onThemeThumbClick:function(){this.setThemeMetrics(["Клик по теме"])},onHide:function(){this.stopWizardStep()},onStepSkipped:function(){this.setThemeMetrics(["Пропустить"])},onSubmitClick:function(e){e.preventDefault(),this._defaults=this._getCurrentSettings(),this.setThemeMetrics(["Продолжить"]),this.goToNextStep()},onSkipClick:function(e){e.preventDefault(),this.setThemeMetrics(["Пропустить"]),this.goToNextStep()},onSettingsChanged:function(e,t){var i=this._getSettingsDiffInfo().diff;t.replace(/^\./,"")in i?this._redraw():this.keepValid()},onStepHidden:function(e){var t=this;e&&this.isActive()&&this.setThemeMetrics(["Закрыть"]);var i=ns.Model.get("settings"),n=this._getSettingsDiffInfo(),o=n.diff;if(n.isDirty){i.setSettings(o,function(){t._defaults=t._getCurrentSettings(),t._redraw()}),o.color_scheme&&i.trigger("daria:vWelcomeWizardThemeStep:setTheme",this._defaults.color_scheme);var s=ns.Model.get("theme-"+this._defaults.color_scheme);s.setCurrentSkin(s.getSkinParams()),ns.page.go()}},_getCurrentSettings:function(){var e=ns.Model.get("settings");return["color_scheme","colorful-theme-skin","seasons-modifier","geoid"].reduce(function(t,i){return t[i]=e.getSetting(i),t},{})},_compareCurrentSettings:function(e){var t=this._getCurrentSettings();return Object.keys(e).reduce(function(i,n){return e[n]!==t[n]&&(i[n]=e[n]),i},{})},_getSettingsDiffInfo:function(){if(!this._defaults)return{isDirty:!1,diff:{}};var e=this._compareCurrentSettings(this._defaults);return{isDirty:Object.keys(e).length>0,diff:e}},_redraw:function(){this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},isDirty:function(){return this._getSettingsDiffInfo().isDirty},getSubmitButtonText:function(){return this.isDirty()?i18n("%Сохранить"):i18n("%Promo_Подтвердить_шаг")},setThemeMetrics:function(e){var t=["Приветственный визард","Темы"];Jane.c(t.concat(e))}}},"wizard-step-mixin")},2315:function(e,t){ns.View.define("welcome-wizard-themes-selector-wrapper",{events:{"daria:vThemesSelector:new-schema@show":"updateSubviews"},params:function(e){return e},models:{settings:{"ns-model-changed":"filteredUpdateSubviews"}},yateModule:"promo",methods:{filteredUpdateSubviews:function(e,t){".color_scheme"!==t&&".geoid"!==t&&this.updateSubviews()},updateSubviews:function(){this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})}}})},2316:function(e,t){ns.View.define("welcome-wizard",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click .js-go-to-step":"onGoToStepClick","daria:WelcomeWizard:closed":"onWizardPopupClosed"},params:function(){return{wizard_name:"welcome"}},models:{"wizard-state":{"ns-model-changed":"keepValid","ns-model-changed.activeStep":"onWizardStateActiveStepChanged"}},yateModule:"promo",methods:{_animationSpeed:400,onShow:function(){this.getModel("wizard-state").reset(),$("html").addClass("with-WelcomeWizard")},onHide:function(){$("html").removeClass("with-WelcomeWizard")},onGoToStepClick:function(e){var t=e.currentTarget;if(t){var i=this.getModel("wizard-state");if(!i.isTransitionLocked()){var n=i.getActiveStep(),o=t.dataset.step;i.setStep(o),i.trigger("daria:WelcomeWizard:dotNavigation",n,o)}}},onWizardStateActiveStepChanged:function(){this._animateStepChange(),this._updateStepToggler()},onWizardPopupClosed:function(){this._animationTimer&&(clearTimeout(this._animationTimer),this._animationTimer=null)},_animateStepChange:function(){var e=this,t=this.getModel("wizard-state"),i=t.getActiveStep(),n=t.getPrevActiveStep(),o=this.$node.find('*[data-step-id="'+i+'"]'),s=this.$node.find('*[data-step-id="'+n+'"]');if(t.isFirstLoad())return o.removeClass("is-hidden"),$(window).trigger("resize"),t.firstLoadDone(),t.trigger("daria:WelcomeWizard:stepAnimationStart",null,i),void t.trigger("daria:WelcomeWizard:stepAnimationEnd",null,i);t.lockTransition(),t.trigger("daria:WelcomeWizard:stepAnimationStart",n,i),s.addClass("will-be-hidden"),o.removeClass("is-hidden"),o.addClass("will-be-shown"),this._animationTimer=setTimeout(function(){s.removeClass("will-be-hidden"),s.addClass("is-hidden"),o.removeClass("will-be-shown"),e._animationTimer=setTimeout(function(){e._animationTimer=null,t.unlockTransition(),t.trigger("daria:WelcomeWizard:stepAnimationEnd",n,i),$(window).trigger("resize")},e._animationSpeed)},this._animationSpeed)},_updateStepToggler:function(){for(var e,t,i=this.getModel("wizard-state"),n=i.getActiveStep(),o=i.getSteps(),s=!1,a=0;a<o.length;a++)e=o[a],s=e===n,t=i.getStepWasShown(e),this.$node.find('[data-step="'+e+'"]').toggleClass("mail-WelcomeWizard-StepToggler-Item_active",s).toggleClass("mail-WelcomeWizard-StepToggler-Item_new",!t).toggleClass("js-go-to-step",!s)}}})},2317:function(e,t){ns.View.edefine("welcome-wizard-popup",{yateModule:"promo",events:{"wheel window":"onWheel","keydown window":"onKeydown"},methods:{open:function(e){var t=this,i=_.extend({wizard:!0},this.params);this.updateByLayout("welcome-wizard-popup",i,{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopup=nb.block(this.node,{"click .js-welcome-wizard-close":function(e){e.preventDefault(),t.close()}}),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))},this)},close:function(){this.nbPopup&&(this.nbPopup.close(),ns.events.trigger("daria:WelcomeWizard:closed"))},onKeydown:function(e){e.keyCode===Jane.Common.keyCode.ESC&&(Daria.Dialog.isOpen()?Daria.Dialog.close():this.close())},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.destroy()})},getScrollContent:function(e){return $(e.target).closest(".js-themes-list")[0]}}},"prevent-scroll-propagation-mixin",ns.View)},2318:function(e,t){!function(){ns.View.define("inline-wizard",{models:{"inline-wizard-container-state":{"ns-model-changed":!1,"ns-model-changed.isContainerReady":"showWizard"},settings:{"ns-model-changed":!1,"ns-model-changed.disable_promo":"onDisablePromo"},"user-apps-activity":!1,"inline-wizard-state":{"ns-model-changed":!1,"ns-model-changed.allViewsHide":"onViewsHideChange","ns-model-changed.allViewsClose":"onViewsCloseChange"}},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-hide":"onHide"},yateModule:"promo",methods:{onHtmlInit:function(){if(!Daria.InlineWizard.hasAvailableSteps(this.params))return void this.$node.addClass("is-hidden");this.getModel("inline-wizard-container-state").set(".isWizardReady",!0),this.$node.removeClass("is-hidden"),this.showWizard()},showWizard:function(){var e=this.getModel("inline-wizard-container-state");e.isContainerReady()&&e.isWizardReady()&&!e.isWizardOpen()&&(this.showOnPage(),Daria.InlineWizard.start(this.node),Daria.InlineWizard.openBeforeRender(),e.set(".isWizardOpen",!0))},onDisablePromo:function(){this.invalidate(),this.render()},render:function(){var e={_yateModule:"promo"};new ns.Update(this,ns.layout.page("wizard-inline",e),e,{execFlag:ns.U.EXEC.PARALLEL}).render()},showOnPage:function(){$(".js-inline-wizard-dummy").append(this.$node)},onHide:function(){var e=this.getModel("inline-wizard-container-state");this.$node.off(".inline-wizard"),e.set(".isWizardOpen",!1),e.set(".isWizardReady",!1)},onViewsHideChange:function(){var e=this.getModel("inline-wizard-state").get(".allViewsHide");this.$node.toggleClass("is-hidden",e),this.getModel("inline-wizard-container-state").set(".isWizardOpen",!e)},onViewsCloseChange:function(){var e=this.getModel("inline-wizard-state"),t=e.get(".allViewsClose"),i=e.get(".closeWithAnimation");t&&(this.getModel("inline-wizard-container-state").set(".isWizardOpen",!1,{silent:!0}),Daria.InlineWizard.close(!i))}}})}()},2319:function(e,t){!function(){var e=ns.View.infoLite("promo-mobile-app-common"),t=e.methods.PROMO_TYPES;ns.View.define("inline-wizard-mobile-app-step",{models:{"promo-mobile-app-state":"onStateChanged",userphones:!1,"user-apps-activity":!1,"inline-wizard-state":!1,settings:{"ns-model-changed":!1,"ns-model-changed.liza_minified":"onResize","ns-model-changed.liza_minified_header":"onResize"}},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","click .js-get-mobile-app-link":"sendMobileAppLink","click .js-promo-mobile-app-close-button":"closeView","daria:vMessages:messages-load-start":"onMoreMessages","daria:vApp:changeRightColumSize@show":"onResize","ns-page-before-load":"onPageBeforeLoad","ns-page-after-load":"onPageAfterLoad","daria:vMessagesItemWrap:message-opened":"onMessageOpen","daria:vMessagesItemThreadExpandMixin:thread-expanded":"onMoreMessages"},yateModule:"promo",isActive:!1,params:function(){return{promo:"mobile-app-inline-wizard"}},_checkConditions:function(){var i,n=Daria.promoNow(),o=ns.Model.get("settings"),s=e.methods.canShowByMobileActivity(),a=e.methods.getPromoType(),r=ns.Model.get("settings").getSetting("inline-wizard-mobile_close"),l=Daria.isMessageOpenedInList(),d=Number(o.getSetting("promo-mobile_sms-send_date"))||0,c=Number(o.getSetting("inline-wizard-mobile_show-date"))||0,h=Number(o.getSetting("inline-wizard-mobile_cr-date"))||0,u=Number(o.getSetting("inline-wizard-mobile_cr-count"))||0,p=Daria.Config.firstLogin,m=Daria.getAccountAgeInDays()>=1,g=o.getSetting("disable_promo"),f=n-d>3*Jane.Date.MONTH,S=c?n-c:0,w=S>=10*Jane.Date.MINUTE,b=n-c>2*Jane.Date.WEEK,v=this.isActive?w:!b,_=n-h;i=u>=3?_>6*Jane.Date.MONTH:a===t.NEW_PROMO||a===t.FORGOT_PROMO?_>6*Jane.Date.WEEK:_>3*Jane.Date.MONTH,v&&!r&&(o.setSettings({"inline-wizard-mobile_close":!0}),Daria.InlineWizard.close());var C=!(m&&f&&i&&s);return!(Daria.IS_CORP||Daria.is3pane()||p||g||C||v||l)},shouldShow:function(){return this._checkConditions()},getLayout:function(){return{name:"inline-wizard-mobile-app-step",childViews:{}}},methods:{promoMobileAppName:"mail-promo-inbox-bottom",PICTURE_PREFIX:"MailAppLink2",PICTURE_PREFIX_RU:"MailAppLink3",CUSTOM_CLASSES:"mail-PromoMobileApp_inlineWizard",VIEW_PREFIX_CLASS:"mail-PromoMobileApp",metrikaData:null,onShowAction:function(){this.$resizeNode=$(".js-mail-layout-content"),this.onResize();var e=ns.View.infoLite("inline-wizard-mobile-app-step"),t=ns.Model.get("settings"),i=Number(t.getSetting("inline-wizard-mobile_cr-count"))||0;(Number(ns.Model.get("settings").getSetting("inline-wizard-mobile_show-date"))||0)&&e.isActive||ns.Model.get("settings").setSettings({"inline-wizard-mobile_show-date":Daria.now(),"inline-wizard-mobile_close":!1}),i>=3&&t.setSettings({"inline-wizard-mobile_cr-count":0}),e.isActive=!0},onSendSuccess:function(){this.closeWithDelay()},initAppName:function(e){switch(e){case this.PROMO_TYPES.FORGOT_PROMO:this.promoMobileAppName="mail-promo-inbox-2";break;case this.PROMO_TYPES.UPDATE_PROMO:this.promoMobileAppName="mail-promo-inbox-bottom";break;default:this.promoMobileAppName="mail-promo-inbox"}},initMetrikaData:function(e){this._initMetrikaData(e,["Визард внизу (под списком)"])},onErrorCanNotRetry:function(){this.closeWithDelay()},closeWithDelay:function(e){var t=e||3e3,i=this;setTimeout(function(){i.isVisible()&&i.closeViewAction(!0)},t)},onMoreMessages:function(){this.getModel("inline-wizard-state").get(".allViewsHide")||this.closeViewAction(!0,!0)},closeViewAction:function(e,t){var i=ns.Model.get("settings"),n=Number(i.getSetting("inline-wizard-mobile_cr-count"))||0,o={"inline-wizard-mobile_close":!0};e||(o["inline-wizard-mobile_cr-date"]=Daria.now(),o["inline-wizard-mobile_cr-count"]=n+1),i.setSettings(o);var s=this.getModel("inline-wizard-state");s.set(".closeWithAnimation",!t),s.set(".allViewsClose",!0)},onPageBeforeLoad:function(e,t){var i=t[0],n=t[1],o="messages"===i.page,s="messages"===n.page,a=ns.Model.get("folders").getFidBySymbol("inbox"),r=o&&s&&i.params.current_folder===n.params.current_folder,l=s&&n.params.current_folder===a,d=ns.View.infoLite("inline-wizard-mobile-app-step");if(!r)return d.shouldShow()?void(s&&!l&&this.toggleViewHide(!0)):void this.closeViewAction(!0,!0)},onPageAfterLoad:function(){var e=ns.page.current.params,t=ns.Model.get("folders").getFidBySymbol("inbox");"messages"===ns.page.current.page&&e.current_folder===t&&this.toggleViewHide(!1)},onMessageOpen:function(){Daria.isMessageOpenedInList()&&!this.getModel("inline-wizard-state").get(".allViewsHide")&&this.closeViewAction(!0,!0)},toggleViewHide:function(e){this.getModel("inline-wizard-state").setIfChanged(".allViewsHide",e)}}},"promo-mobile-app-common")}()},2320:function(e,t){yr.externals["get-default-email-address"]=function(){return ns.Model.get("settings").getSetting("default_email")}}});