webpackJsonp([7],{149:function(t,e,o){Jane.module("toolbar.js",function(){"use strict";o(2671),o(2673),o(2675),o(2680),o(2733)})},2671:function(t,e,o){o(2672)},2672:function(t,e){ns.action.define("toolbar.settings.button.remove",function(t,e){var o=e.button,n=Daria.userToolbar.deactivateButton(o);return _.isArray(n)&&(Daria.userToolbar.set(),ns.events.trigger("daria:vToolbarSettings:buttonToggled")),!1})},2673:function(t,e,o){o(2674)},2674:function(t,e){!function(){Daria.userToolbar={mSettings:function(){return this._mSettings||(this._mSettings=ns.Model.get("settings")),this._mSettings},_KEY:"tb_mail_mailbox",_KEY_ACTIVATED:"tb_mail_mailbox_act",_getSettingsValue:function(){return this.mSettings().getSetting(this._KEY)||[]},_cache:null,validate:function(t){return _.filter(t,function(t){switch(t.id){case Daria.Constants.TOOLBAR_BUTTONS.LABEL:var e=ns.Model.get("labels");return e&&e.getLabelById(t.settings.label);case Daria.Constants.TOOLBAR_BUTTONS.INFOLDER:var o=ns.Model.get("folders");return o&&o.getFolderById(t.settings.folder);case Daria.Constants.TOOLBAR_BUTTONS.SENDON:return t.settings.email&&Jane.FormValidation.checkEmail(t.settings.email)}return!0})},get:function(t){return _.isNull(this._cache)&&(this._cache=this._getSettingsValue()),this._cache=this.validate(this._cache),t?this._getSettingsByButtonId(this._cache,t)||null:this._cache},set:function(t){t=t||this._cache;var e=new Vow.Promise,o={};return o[this._KEY]=t,this.mSettings().setSettings(o,function(o){o?e.fulfill(t):e.reject()}),e},activate:function(){var t=new Vow.Promise;return this.mSettings().setSettingOn(this._KEY_ACTIVATED,function(){t.fulfill()}),t},isActivated:function(){return!Daria.Config.NO_SETTINGS&&this.mSettings().isSet(this._KEY_ACTIVATED)},getCustomizableButtonName:function(t){var e=this.get(t);if(e)switch(t){case Daria.Constants.TOOLBAR_BUTTONS.LABEL:return ns.Model.get("labels").getLabelById(e.settings.label).name;case Daria.Constants.TOOLBAR_BUTTONS.INFOLDER:return ns.Model.get("folders").getFolderById(e.settings.folder).name;case Daria.Constants.TOOLBAR_BUTTONS.SENDON:return e.settings.email;default:return}},activateButton:function(t,e){var o={id:t,settings:e},n=_.findIndex(this._cache,{id:t});return-1!==n?this._cache[n]=o:this._cache.push(o),this._cache},deactivateButton:function(t){return this._cache=_.reject(this._cache,{id:t}),this._cache},isButtonActivated:function(t){return _.isNull(this._cache)&&(this._cache=this._getSettingsValue()),Boolean(this._getSettingsByButtonId(this._cache,t))},invalidateCache:function(){this._cache=null},_getSettingsByButtonId:function(t,e){return _.find(t,{id:e})}}}()},2675:function(t,e,o){o(2676),o(2677),o(2678),o(2679)},2676:function(t,e){!function(){var t=[{id:Daria.Constants.TOOLBAR_BUTTONS.MAIN_SELECT_ALL,action:"select-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:i18n("%Shortcuts_key_Select_all")},{id:Daria.Constants.TOOLBAR_BUTTONS.MAIN_DESELECT_ALL,action:"deselect-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:i18n("%Toolbar_Снять_выделение")},{id:Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_GO,url:"#compose",action:"compose.go",icon:"Compose",name:i18n("%Toolbar_Написать"),title:i18n("%Toolbar_Написать")+Daria.Shortcuts.getShortcutLabelFor("New_mail","global",!0)},{id:Daria.Constants.TOOLBAR_BUTTONS.DRAFT_FINISH,icon:"Compose",name:i18n("%Toolbar_Дописать"),title:i18n("%Toolbar_Дописать")},{id:Daria.Constants.TOOLBAR_BUTTONS.CHECK_MAIL,action:"mailbox.check",icon:"Refresh",name:i18n("%Toolbar_Проверить"),title:i18n("%Toolbar_Проверить_title")+Daria.Shortcuts.getShortcutLabelFor("Check_new_mail","global",!0)},{id:Daria.Constants.TOOLBAR_BUTTONS.ADD_TEMPLATE,icon:"AddTemplate",name:i18n("%Toolbar_Создать_шаблон")},{id:Daria.Constants.TOOLBAR_BUTTONS.EDIT,action:"compose-edit",icon:"Edit",name:i18n("%Изменить"),disableLoader:!0,_visible:function(){if(!Daria.isMessagePage())return!1;var t=ns.Model.get("messages-checked");if(1!==t.getCount())return!1;var e=t.getCheckedMessages()[0];return ns.Model.get("folders").isFolder(e.getFolderId(),["draft","template"])}},{id:Daria.Constants.TOOLBAR_BUTTONS.REPLY,action:"reply",icon:"Reply",disableLoader:!0,name:i18n("%Toolbar_Ответить"),title:i18n("%Toolbar_Ответить")+Daria.Shortcuts.getShortcutLabelFor("Reply","message",!0),_visible:function(){if(Daria.isMessagePage()){var t=ns.Model.get("messages-checked");if(1===t.getCount()){var e=t.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(e.getFolderId(),["draft","template"])}}return!0}},{id:Daria.Constants.TOOLBAR_BUTTONS.REPLY_ALL,action:"reply-all",icon:"Replyall",disableLoader:!0,name:i18n("%Toolbar_Ответить_всем"),title:i18n("%Toolbar_Ответить_всем")+Daria.Shortcuts.getShortcutLabelFor("Reply_all","message",!0),_visible:function(){if(Daria.isMessagePage()){var t=ns.Model.get("messages-checked");if(1===t.getCount()){var e=t.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(e.getFolderId(),["draft","template"])}}return!0}},{id:Daria.Constants.TOOLBAR_BUTTONS.FORWARD,action:"forward",icon:"Forward",name:i18n("%Toolbar_Переслать"),title:i18n("%Toolbar_Переслать")+Daria.Shortcuts.getShortcutLabelFor("Forward","messages",!0),_visible:function(){return!ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,["template"])}},{id:Daria.Constants.TOOLBAR_BUTTONS.DELETE,action:"remove",folderAction:"folder.messages-remove",icon:"Delete",actionParams:function(){var t={};return"message"===ns.page.current.page&&(t.ignoreUnsavedDraft=!0),t},name:i18n("%Toolbar_Удалить"),title:i18n("%Toolbar_Удалить")+Daria.Shortcuts.getShortcutLabelFor("Delete_selected","messages",!0)},{id:Daria.Constants.TOOLBAR_BUTTONS.SPAM,action:"tospam",icon:"Spam",name:i18n("%Toolbar_Это_спам"),title:i18n("%Toolbar_Это_спам")+Daria.Shortcuts.getShortcutLabelFor("Label_spam","message",!0)},{id:Daria.Constants.TOOLBAR_BUTTONS.NOT_SPAM,action:"notspam",icon:"Unspam",name:i18n("%Toolbar_Не_спам")},{id:Daria.Constants.TOOLBAR_BUTTONS.UNSUBSCRIBE,action:"unsubscribe",icon:"Unsubscribe",name:i18n("%Toolbar_Unsubscribe")},{id:Daria.Constants.TOOLBAR_BUTTONS.MARK_AS_READ,action:"mark",folderAction:"folder.current-mark-read",disableLoader:!0,icon:"Read",name:i18n("%Toolbar_Прочитано"),title:i18n("%Toolbar_Прочитано")+Daria.Shortcuts.getShortcutLabelFor("Label_read","messages",!0)},{id:Daria.Constants.TOOLBAR_BUTTONS.MARK_AS_UNREAD,action:"unmark",disableLoader:!0,icon:"Unread",name:i18n("%Toolbar_Не_прочитано"),title:i18n("%Toolbar_Не_прочитано")+Daria.Shortcuts.getShortcutLabelFor("Label_unread","messages",!0)},{id:Daria.Constants.TOOLBAR_BUTTONS.ARCHIVE,action:"archive",icon:"Archive",name:i18n("%Toolbar_Archive"),title:i18n("%Toolbar_Archive")+Daria.Shortcuts.getShortcutLabelFor("Archive","messages",!0),description:i18n("%Toolbar_Archive_Description"),settings:{}},{id:Daria.Constants.TOOLBAR_BUTTONS.LABELS_ACTIONS,icon:"Tag",name:i18n("%Toolbar_Label"),nameArrow:!0,title:i18n("%Toolbar_Label")+Daria.Shortcuts.getShortcutLabelFor("Labels_dialog","messages",!0),description:i18n("%Toolbar_Label_Description"),disableLoader:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.FOLDERS_ACTIONS,icon:"Folder",name:i18n("%Toolbar_Infolder"),nameArrow:!0,title:i18n("%Toolbar_Infolder")+Daria.Shortcuts.getShortcutLabelFor("Folders_dialog","messages",!0),description:i18n("%Toolbar_Infolder_Description"),disableLoader:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.PIN,action:"pin",icon:"Pin",name:i18n("%Pinned_Запинить_письмо"),_visible:function(){if(Daria.isMessagePage()){var t=ns.Model.get("messages-checked");if(1===t.getCount()){var e=t.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(e.getFolderId(),["draft","template"])}}return!0}},{id:Daria.Constants.TOOLBAR_BUTTONS.UNPIN,action:"unpin",icon:"Pin_active",name:i18n("%Pinned_Распинить_письмо"),_visible:function(){if(Daria.isMessagePage()){var t=ns.Model.get("messages-checked");if(1===t.getCount()){var e=t.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(e.getFolderId(),["draft","template"])}}return!0}},{id:Daria.Constants.TOOLBAR_BUTTONS.SENDON,action:"sendon",icon:"SmartForward",name:i18n("%Toolbar_Sendon"),originalName:i18n("%Toolbar_Sendon"),title:i18n("%Toolbar_Sendon")+Daria.Shortcuts.getShortcutLabelFor("Sendon","messages",!0),description:i18n("%Toolbar_Sendon_Description"),settings:{email:null},isCustom:!0,_settingsValidate:function(t){var e=[];return t.email?Jane.FormValidation.checkEmail(t.email)||e.push("sendon_check_email"):e.push("sendon_empty_email"),e}},{id:Daria.Constants.TOOLBAR_BUTTONS.INFOLDER,action:"infolder",icon:"MagicFolder",name:i18n("%Toolbar_Infolder"),originalName:i18n("%Toolbar_Infolder"),title:i18n("%Toolbar_Infolder")+Daria.Shortcuts.getShortcutLabelFor("Infolder","messages",!0),description:i18n("%Toolbar_Infolder_Description"),settings:{folder:null},settingsDeps:["folders"],isCustom:!0,_settingsValidate:function(t){var e=[];return t.folder||e.push("folder_empty"),e}},{id:Daria.Constants.TOOLBAR_BUTTONS.LABEL,action:"label",icon:"MagicTag",name:i18n("%Toolbar_Label"),originalName:i18n("%Toolbar_Label"),title:i18n("%Toolbar_Label")+Daria.Shortcuts.getShortcutLabelFor("Defined_label","messages",!0),description:i18n("%Toolbar_Label_Description"),disableLoader:!0,settings:{label:null},settingsDeps:["labels"],isCustom:!0,_settingsValidate:function(t){var e=[];return t.label||e.push("label_empty"),e}},{id:Daria.Constants.TOOLBAR_BUTTONS.TEMPLATE,action:"reply-tmpl",icon:"Template",name:i18n("%Toolbar_Template"),title:i18n("%Toolbar_Template")+Daria.Shortcuts.getShortcutLabelFor("Defined_reply","messages",!0),description:i18n("%Toolbar_Template_Description"),settings:{tmpl:null},settingsDeps:["messages"],isCustom:!0,_settingsDepsParams:function(){var t=Vow.promise();return ns.Model.get("folders").createTemplateFolder().then(function(e){t.fulfill({current_folder:e.fid,first:0,last:500})},function(){t.reject()}),t},_settingsValidate:function(t){var e=[];return t.tmpl||e.push("template_empty"),e}},{id:Daria.Constants.TOOLBAR_BUTTONS.MORE,icon:"More",name:i18n("%Toolbar_More")},{id:Daria.Constants.TOOLBAR_BUTTONS.TOOLBAR_SETTINGS,action:"customize",iconId:"mail--Settings",name:i18n("%Toolbar_Settings"),settings:{},settingsHide:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.DELETE_DRAFT,action:"remove.draft",icon:"Delete",name:i18n("%Toolbar_Удалить_черновик"),_visible:function(){var t=ns.Model.get("messages-checked");if(1!==t.getCount())return!1;var e=t.getCheckedMessages()[0];return ns.Model.get("folders").isFolder(e.get(".fid"),["draft","template"])}},{id:Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_REPLY,action:"compose.reply",icon:"reply",disableLoader:!0,name:i18n("%Toolbar_Ответить"),_visible:function(){return Boolean(ns.page.current.params.ids&&ns.page.current.params.ids.length&&"reply-all"===ns.page.current.params.oper&&Jane.watcher.get("compose.has-multiply-reply-addresses"))}},{id:Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_REPLY_ALL,action:"compose.reply-all",icon:"reply-all",disableLoader:!0,name:i18n("%Toolbar_Ответить_всем"),_visible:function(){return Boolean(ns.page.current.params.ids&&ns.page.current.params.ids.length&&"reply"===ns.page.current.params.oper&&Jane.watcher.get("compose.has-multiply-reply-addresses"))}},{id:Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_ABOOK,url:"#compose",action:"abook.compose-go",iconId:"mail--MainToolbar-Compose",disableLoader:!0,name:i18n("%Toolbar_Написать")},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_SELECT_ALL,action:"abook.select-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:i18n("%АК_Выделить_все_контакты")},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_DESELECT_ALL,action:"abook.deselect-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:i18n("%Toolbar_Снять_выделение")},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_ADD,action:"mail-common.person-popup",iconId:"mail--MainToolbar-AddContact",name:i18n("%Toolbar_Добавить_контакт"),disableLoader:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_REMOVE,action:"abook.remove-contacts",iconId:"mail--MainToolbar-Delete",name:i18n("%Toolbar_Удалить"),disableLoader:!0,droppable:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_TO_GROUP,action:"abook.groups-dropdown",iconId:"mail--MainToolbar-AddGroup",name:i18n("%АК_Добавить_в_группу"),disableLoader:!0,droppable:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_OUT_OF_GROUP,action:"abook.remove-contacts-from-group",iconId:"mail--MainToolbar-DeleteGroup",name:i18n("%АК_Удалить_из_группы"),disableLoader:!0,droppable:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_RESTORE,action:"abook.open-backups-dialog",iconId:"mail--MainToolbar-Restored",name:i18n("%AK_Восстановить"),disableLoader:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.ABOOK_MORE,action:"abook.toolbar-more-actions",iconId:"mail--MainToolbar-More",name:i18n("%Toolbar_More"),disableLoader:!0},{id:Daria.Constants.TOOLBAR_BUTTONS.TRANSLATE,action:"translate.show-infoline",name:i18n("%Message_Translate"),disableLoader:!0,_visible:ns.False},{id:Daria.Constants.TOOLBAR_BUTTONS.PRINT,disableLoader:!0,name:i18n("%Message_Распечатать"),_visible:ns.False,_getExData:function(){return{href:Daria.api.print+"?mid="+ns.page.current.params.ids+"&_uid="+Daria.uid,attrs:{target:"_blank"}}}},{id:Daria.Constants.TOOLBAR_BUTTONS.FILTERS_CREATE,disableLoader:!0,name:i18n("%Message_Создать_правило"),_visible:ns.False,_getExData:function(){return{href:"#setup/filters-create?message="+ns.page.current.params.ids,class:["ns-action"],attrs:{"data-click-action":"message.counter-filters-create"}}}},{id:Daria.Constants.TOOLBAR_BUTTONS.MESSAGE_SOURCE,disableLoader:!0,name:i18n("%Message_Свойства_письма"),_visible:ns.False,_getExData:function(){return{href:Daria.api["message-source"]+"/"+Daria.uid+"/"+ns.page.current.params.ids+"/yandex_email.eml",class:["ns-action","js-toolbar-item-message-properties"],attrs:{target:"_blank","data-click-action":"message.counter-properties"}}}}];ns.Model.define("all-toolbar-buttons",{events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData(t)},getButtonById:function(t){return _.find(this.getData(),{id:t})},getButtonsByIds:function(t){return _.filterValuesContainingPropValue(this.getData(),"id",t)},getOrExtendButton:function(t){return _.isString(t)?this.getButtonById(t):_.extend({},this.getButtonById(t.id),t)},getButtonsByDeclarations:function(t){return _.map(t,this.getOrExtendButton,this)}}})}()},2677:function(t,e){!function(){ns.Model.define("toolbar",{split:{items:".item",params:{id:".id"},model_id:"toolbar-button"},params:{layout:null},events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData({buttons:[]})},preprocessData:function(t){return t.buttons&&(t.item=t.buttons),delete t.buttons,t.fixed=!1,t},setFixedSupport:function(t){Jane.watcher.set("toolbar.allowfixed",Boolean(t))},getFixedSupport:function(){return Jane.watcher.get("toolbar.allowfixed")},toggleFixed:function(t){return this.get(".fixed")!==t&&(this.set(".fixed",t),!0)},isFixed:function(){return Boolean(this.get(".fixed"))},areSettingsEnabled:function(){return Boolean(this.get(".settings"))},getById:function(t){return _.find(this.models,function(e){return e.get(".id")===t})}}},ns.ModelCollectionStatic)}()},2678:function(t,e){!function(){var t=function(){return Vow.fulfill()};ns.Model.define("toolbar-button",{params:{id:null},ctor:function(){this.toShow=no.True,this.toEnable=no.True,this.init=no.nop,this.getSettingsDepsParams=t,this.validateSettings=no.True,this.getExData=_.noop},methods:{hasDataChanged:function(){return Boolean(!this.data)},preprocessData:function(e){var o=e._visible;return this.toShow=o||no.True,o=e._enable,this.toEnable=o||no.True,o=e._init,this.init=o||no.nop,o=e._settingsDepsParams,this.getSettingsDepsParams=o||t,o=e._settingsValidate,this.validateSettings=o||no.True,this.getExData=e._getExData||_.noop,_.pick(e,function(t,e){return"_"!==e.charAt(0)})},setName:function(t){_.isUndefined(t)?this.resetName():this.setIfChanged(".name",t)},resetName:function(){var t=this.get(".originalName");t&&this.set(".name",t)},isModelWithSettings:function(){return Boolean(this.get(".settings"))},getType:function(){return this.get(".type")},isValid:no.True}},ns.ModelStatic)}()},2679:function(t,e){ns.Model.define("mops-confirmation",{events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData({})},getData:function(){return this.getMops()},getMops:function(){return{action:this.data.action||null,callback:this.data.callback||null,count:this.data.count||0}},setMops:function(t){this.setData(t)}}},ns.ModelStatic)},2680:function(t,e,o){o(2681),o(2682),o(2683),o(2684),o(2685),o(2686),o(2687),o(2688),o(2728),o(2730),o(2731),o(2732)},2681:function(t,e){!function(){ns.View.edefine("folders-actions",{models:{folders:!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-action":"onClickAction","click@show .js-folder-new":"createNewFolder","keydown@show .js-search-input":"_onSearchInput"},yateModule:"toolbar",methods:{elContentSelector:".js-folder-name",elSelector:".js-kbd-fldr-nav:visible",skipElSelector:"b-folders__folder_current",selectedClass:"b-folders__folder_kbd-selected",newListSelector:".mail-FilterList-List .js-folder-new",onInit:function(){this._filterRefresh=_.debounce(this._filterRefresh,100),this.resetKdbSelection=_.debounce(this.resetKdbSelection,150)},onShow:function(){this.$foldersHolder=this.$node.find(".js-folders-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByMessagesChecked()},onHide:function(){this._filterRefresh.cancel(),this.resetKdbSelection.cancel(),this.$foldersHolder=null,this.$searchInput=null},onClickAction:function(t){var e=ns.action.getParams(t.currentTarget),o=$(t.currentTarget).data("click-action");return e.fid!==this.disabledFolderFid&&("folders.add"===o?this.createNewFolder(e):(this._getCheckedModel().runAction(o,e),this.closePopup()),t.preventDefault(),!1)},open:function(t,e,o){var n=this;this.__mMessagesChecked=e,this._isOpen=!0;var i=this.getOpenOptions(o);return this.update().then(function(){var e=Jane.tt("toolbar:mail-FilterList-popup");n.nbPopup=nb.block(e),n.nbPopup.setContent(n.node),n.nbPopup.open(_.extend(i,{where:t})),n.bindEvents(),n.bindEvents();var o=_.once(function(){n._isOpen=!1,n.unbindEvents(),n.destroy(),_.defer(function(){n.nbPopup.destroy()})});n.nbPopup.on("nb-closed",o)})},bindEvents:function(){this.nbPopup.$node.on("mousedown",this._preventDefaultAndStopPropagation)},unbindEvents:function(){this.nbPopup.$node.off("mousedown",this._preventDefaultAndStopPropagation)},getFolderName:function(){return this.$searchInput&&this.$searchInput.length?$.trim(this.$searchInput.val()):""},createNewFolder:function(t){this.closePopup(),t=$.extend(t||{},{name:this.getFolderName(),toolbar:!0,mMessagesChecked:this._getCheckedModel()}),ns.action.run("folders.add",t)},closePopup:function(){nb.trigger("popup-close")},infilteredList:function(t){for(var e=this.filteredList,o=0,n=e.length;o<n;o++)if(e[o].title===t)return!0;return!1},filterFolders:function(t){return this.filteredList=$.grep(this.activeFolders,function(e){var o=!t||!e.current&&0===e.title.indexOf(t);return e.$node.toggleClass("g-hidden",!o),o}),this.filteredList.length},resetKdbSelection:function(){var t=this;t.visibleList[t.kbdSelected]&&t.visibleList[t.kbdSelected].$node.removeClass(t.selectedClass),$(t.newListSelector).removeClass(t.selectedClass),t.visibleList=[],$(t.elSelector).each(function(e,o){var n=$(o);n.hasClass(t.skipElSelector)||t.visibleList.push({$node:n,title:n.find(t.elContentSelector).text()})}),t.kbdSelected=null},makeFakeFolder:function(t){var e=Jane.tt("toolbar:new-fake-folder",{name:t,"name-param":encodeURIComponent(t)});this.$fakeFolder?this.$fakeFolder.replaceWith(e):this.$foldersHolder.append(e),this.$fakeFolder=$(e),this.visibleList.push({title:"fake folder",$node:this.$fakeFolder})},removeFakeFolder:function(){var t=this.$fakeFolder;t&&(t.remove(),this.$fakeFolder=null)},filterByMessagesChecked:function(){var t=this,e=this._getCheckedModel().getCount(),o=this._getCheckedModel().getFolders(),n=this.$node,i=$(n),s=this.activeFolders=[];this.filteredList=[],this.visibleList=[],$.each(o,function(o,n){var a=n===e;a&&(t.disabledFolderFid=o);var r=i.find(".folder-"+o).toggleClass("b-folders__folder_current",a),l=r.find(".js-folder-name").text().toLowerCase(),d={$node:r,title:l,current:a};s.push(d),""===l||a||t.visibleList.push(d)}),this.removeFakeFolder(),this.prevSearch=null,this.$searchInput.val(""),this.filterFolders(""),this.resetKdbSelection()},_getCheckedModel:function(){return this.__mMessagesChecked},_filterRefresh:function(){if(this.$searchInput){var t=this.getFolderName(),e=t.toLowerCase();null===this.prevSearch&&(this.prevSearch=""),e!==this.prevSearch&&(this.prevSearch=e,this.filterFolders(e),e.length&&!this.infilteredList(e)?this.makeFakeFolder(t):this.removeFakeFolder(),this.resetKdbSelection())}},_onSearchInput:function(t){var e=Jane.Common.keyCode;switch(t.which){case e.ENTER:if(null!==this.kbdSelected&&this.kbdSelected>-1)return t.stopImmediatePropagation(),this.visibleList[this.kbdSelected]?this.visibleList[this.kbdSelected].$node.find("[data-click-action]").trigger("click"):this.createNewFolder(),!1;if(this._filterRefresh(),this.filteredList.length&&this.$fakeFolder)return!1;this.filteredList.length<=1&&(t.stopImmediatePropagation(),(this.$fakeFolder||this.filteredList[0].$node).find("[data-click-action]").trigger("click"));break;case e.DOWN:this.moveKbdCursor("down"),t.stopPropagation();break;case e.UP:this.moveKbdCursor("up"),t.stopPropagation();break;default:this._filterRefresh()}return!0}}},"kbd-dropdown-actions")}()},2682:function(t,e){ns.View.define("inbox-filter",{events:{"ns-view-htmlinit":"onNsViewHtmlinit","ns-view-show":"onNsViewShow",pageinit:"_metrikForChangeUser"},models:["messages-types"],yateModule:"toolbar",methods:{onNsViewHtmlinit:function(){nb.init(this.node);var t=nb.$block(".js-content-toolbar-toggler",this.node);t&&t.on("nb-open-started",function(){o.setActiveItem(e)});var e=nb.$block(".js-content-toolbar-inbox-filter-popup",this.node),o=this;if(e){var n=function(t,o){o&&e.close()};e.on("nb-opened",function(){ns.events.on("toolbar.fixed",n),e.$node.on("click.toolbar-filter-inbox-popup",o.onClickTypesFilterNbSelect.bind(o))}),e.on("nb-select",function(){ns.events.trigger("daria:vMessages:recalculate")}),e.on("nb-closed",function(){ns.events.off("toolbar.fixed",n),e.$node.off(".toolbar-filter-inbox-popup")})}},onNsViewShow:function(){ns.events.trigger("daria:vToolbarButton:restruct")},metrika:function(){var t=["Фильтр по типам писем"].concat(Array.prototype.slice.call(arguments,0));Jane.c.apply(Jane,t)},_metrikForChangeUser:function(){Daria.urlParams.addMultiUserFromSelect&&Jane.c(["Фильтр по типам писем","Селект","Клик","Добавить пользователя","Пользователь добавлен"])},setActiveItem:function(t){var e=ns.page.currentUrl,o=t.$node.find(".is-current");if(o.attr("href")!==e){o.removeClass("is-current");var n=t.$node.find('.js-mail-Toolbar-Filter-item[href*="'+e+'"]');n.length?n.addClass("is-current"):t.$node.find(".ui-menu-item:first-child .js-mail-Toolbar-Filter-item").addClass("is-current")}},onClickTypesFilterNbSelect:function(){this.metrika("Селект","Клик")}}})},2683:function(t,e){var o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t[n]=o[n])}return t};ns.View.define("more-services",{models:{"index-data":!0,"header-logo-data":!0},events:{"ns-page-before-load":"onPageBeforeLoad","ns-view-hide":"onHide","click@show":"onClick"},yateModule:"toolbar",ctor:function(){this.nbPopup=null,this.onPopupClosed=this.onPopupClosed.bind(this),this.onChangeToolbarPosition=this.onChangeToolbarPosition.bind(this)},methods:{onHide:function(){this.popupClose()},onPageBeforeLoad:function(){this.popupClose()},_getWorkspaceTabs:function(){var t=this.getModel("header-logo-data").get(".dropdownServices"),e=Boolean(t.servicesAll&&t.servicesAll.id);return[].concat(t.services).concat(e?[{separator:!0},t.servicesAll]:[])},_getRegularTabs:function(){var t=this.getModel("index-data").get(".tabs");return[].concat(t.head).concat(t.more)},_getTabs:function(){return Daria.hasFeature("workspace-header")?this._getWorkspaceTabs():this._getRegularTabs()},onClick:function(){if(!this.popupClose()){var t=this._getTabs().filter(function(t){return"staff"!==t.id}).map(function(t){return o({},t,{class:"js-more-services-tab",attrs:o({},_.contains(["contacts","inbox"],t.id)?{}:{target:"_blank",rel:"noopener"},{"data-metrika-id":t.id})})});this.nbPopup=nb.block(ns.renderNode({tabs:t},"head-tabs-popup","mail")),this.nbPopup.on("nb-closed",this.onPopupClosed),this.nbPopup.open({where:this.$node.find(".js-more-services-toggle"),how:{at:"bottom",my:"top+4"}}),this.nbPopup.$node.on("mousedown",".js-more-services-tab",this.onServicesTabClick.bind(this)),ns.events.on("toolbar.fixed",this.onChangeToolbarPosition),this.registerShowTabs("services")}},onServicesTabClick:function(t){if(t&&"mousedown"===t.type&&(0===t.button||1===t.button)){var e=t.currentTarget;this.registerTabClick(e.getAttribute("data-metrika-id"),"services")}},onPopupClosed:function(){this.nbPopup&&(ns.events.off("toolbar.fixed",this.onChangeToolbarPosition),this.nbPopup.$node.off(),this.nbPopup.destroy(),this.nbPopup=null)},popupClose:function(){return!!this.nbPopup&&(this.nbPopup.close(),!0)},onChangeToolbarPosition:function(t,e){e&&this.popupClose()}}},"services-list-mixin")},2684:function(t,e){!function(){ns.View.edefine("labels-actions",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-action":"_onLabelClick","click@show .js-fake-label":"_onNewLabelClick","click@show .js-label-new":"_onNewLabelClick","click@show .js-read":"_onClickRead","click@show .js-unread":"_onClickUnread","keydown@show .js-search-input":"_onSearchInput"},models:{labels:!1,settings:!1},yateModule:"toolbar",methods:{newListSelector:".js-label-new",selectedClass:"b-mail-dropdown__item-kbd-selected",elContentSelector:".b-mail-dropdown__item__content__wrapper",elSelector:".js-kbd-lbl-nav:visible",onInit:function(){this._filterRefresh=_.debounce(this._filterRefresh,100),this.resetKdbSelection=_.debounce(this.resetKdbSelection,150),this.nbPopup=null},onShow:function(){this.$labelsHolder=this.$node.find(".js-labels-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByMessagesChecked()},onHide:function(){this._filterRefresh.cancel(),this.resetKdbSelection.cancel(),this.$searchInput=null,this.$labelsHolder=null},open:function(t,e,o){var n=this;this.__mMessagesChecked=e,this._isOpen=!0;var i=this.getOpenOptions(o);return this.update(null,{execFlag:ns.U.EXEC.PARALLEL}).then(function(){var e=Jane.tt("toolbar:mail-FilterList-popup");n.nbPopup=nb.block(e),n.nbPopup.setContent(n.node),n.nbPopup.open(_.extend(i,{where:t})),n.bindEvents();var o=_.once(function(){n._isOpen=!1,n.unbindEvents(),n.destroy(),_.defer(function(){n.nbPopup.destroy()})});n.nbPopup.on("nb-closed",o)})},bindEvents:function(){this.nbPopup.$node.on("mousedown",this._preventDefaultAndStopPropagation)},unbindEvents:function(){this.nbPopup.$node.off("mousedown",this._preventDefaultAndStopPropagation)},_getDataFromClickedLabel:function(t){var e=$(t.currentTarget),o=ns.action.getParams(e[0]);return{action:e.data("click-action"),lid:o.lid}},_onLabelClick:function(t){var e=this._getDataFromClickedLabel(t);this._getCheckedModel().runAction(e.action,{lid:e.lid}),this.closePopup()},_onNewLabelClick:function(t){var e=ns.action.getParams(t.currentTarget);e["message-id"]=$(t.currentTarget).attr("data-message-id"),this.createNewLabel(e),this.closePopup()},_onClickRead:function(t){t.preventDefault(),t.stopPropagation(),this._getCheckedModel().runAction("mark"),this.closePopup()},_onClickUnread:function(t){t.preventDefault(),t.stopPropagation(),this._getCheckedModel().runAction("unmark"),this.closePopup()},closePopup:function(){nb.trigger("popup-close")},_onSearchInput:function(t){var e=Jane.Common.keyCode;switch(t.which){case e.ENTER:if(null!==this.kbdSelected&&this.kbdSelected>-1)return t.stopPropagation(),this.visibleList[this.kbdSelected]?this.visibleList[this.kbdSelected].$node.find("a").trigger("click"):(this.createNewLabel(),this.nbPopup.close()),t.preventDefault(),!1;if(this._filterRefresh(),this.filteredList.length&&this.$fakeLabel)return!1;this.filteredList.length<=1&&(t.stopPropagation(),(this.$fakeLabel||this.filteredList[0].$node).find("[data-click-action]").trigger("click"));break;case e.DOWN:this.moveKbdCursor("down"),t.stopPropagation();break;case e.UP:this.moveKbdCursor("up"),t.stopPropagation();break;default:this._filterRefresh()}return!0},_filterRefresh:function(){if(!_.isEmpty(this.$searchInput)){var t=$.trim(this.$searchInput.val()),e=t.toLowerCase();null===this.prevSearch&&(this.prevSearch=""),e!==this.prevSearch&&(this.prevSearch=e,this._filterLabels(e),e.length&&!this.infilteredList(e)?this.makeFakeLabel(t):this.removeFakeLabel(),this.resetKdbSelection())}},getLabelCreatedCallback:function(){var t=this._getCheckedModel();return t.runLabelAction.bind(t)},createNewLabel:function(t){if(!_.isEmpty(this.$searchInput)){var e=Daria.capitalize(this.$searchInput.val().trim());ns.action.run("labels.add",_.extend({},t,{name:e,onLabelCreated:this.getLabelCreatedCallback()}))}},infilteredList:function(t){for(var e=this.filteredList,o=0,n=e.length;o<n;o++)if(e[o].title===t)return!0;return!1},_filterLabels:function(t){this.filteredList=_.filter(this.activeLabels,function(e){var o=!t||0===e.title.indexOf(t);return e.$node.toggleClass("g-hidden",!o),o})},resetKdbSelection:function(){var t=this;this.visibleList&&this.visibleList[this.kbdSelected]&&this.visibleList[this.kbdSelected].$node.removeClass(this.selectedClass),$(this.selectedClass).removeClass(this.selectedClass),this.visibleList=[],$(this.elSelector).each(function(e,o){var n=$(o);t.visibleList.push({$node:n,title:n.find(t.elContentSelector).text()})}),this.kbdSelected=null},makeFakeLabel:function(t){t=Daria.capitalize(t);var e=Jane.tt("toolbar:new-fake-label",{name:t,color:"31c73b"});_.isEmpty(this.$fakeLabel)?this.$labelsHolder.append(e):this.$fakeLabel.replaceWith(e),this.$fakeLabel=$(e),this.visibleList.push({title:"fake label",$node:this.$fakeLabel})},removeFakeLabel:function(){var t=this.$fakeLabel;t&&(t.remove(),this.$fakeLabel=null)},getUnreadMessagesCount:function(t){var e=0;return t.forEach(function(t){var o=ns.Model.get("message",{ids:t});o.getData()&&o.isNew()&&e++}),e},filterByMessagesChecked:function(){var t=this._getCheckedModel(),e=t.getData(),o=this.getUnreadMessagesCount(e),n=t.getCount(),i=t.getLabels();this._filterByLabelsHash(i,{showReadLabel:o>0,showUnreadLabel:o<e.length,messagesCount:n})},_filterByLabelsHash:function(t,e){e=e||{};var o=this.$node,n=o.find(".js-read"),i=o.find(".js-unread");this.activeLabels=[],e.showReadLabel?this._addLabelToActive(n.removeClass("g-hidden")):n.addClass("g-hidden"),e.showUnreadLabel?this._addLabelToActive(i.removeClass("g-hidden")):i.addClass("g-hidden");var s=e.messagesCount||0;_(t).keys().filter(function(t){return!/^FAKE/.test(t)}).each(function(e){var n=t[e],i=o.find(".label-"+e),a=o.find(".unlabel-"+e),r=n===s;r||this._addLabelToActive(i),i.toggleClass("g-hidden",r),a.toggleClass("g-hidden",0===n)},this).value();var a=_(t).filter(function(t,e){return!/^FAKE/.test(e)}).some(function(t){return t>0});o.find(".unlabel-title, .unlabel-separator").toggleClass("g-hidden",!a),this.removeFakeLabel(),this.prevSearch=null,this.$searchInput.val(""),this._filterLabels(""),this.resetKdbSelection()},_addLabelToActive:function(t){this.activeLabels.push({$node:t,title:t.find(".b-mail-dropdown__item__content__wrapper").text().toLowerCase()})},_getCheckedModel:function(){return this.__mMessagesChecked}}},"kbd-dropdown-actions")}()},2685:function(t,e){ns.View.define("layout-switch",{events:{click:"openPopup"},yateModule:"toolbar",ctor:function(){this.onChangeToolbarPosition=this.onChangeToolbarPosition.bind(this),this.offChangeToolbarPosition=this.offChangeToolbarPosition.bind(this)},methods:{openPopup:function(){if(this.vPopup&&this.vPopup.isValid())return void this.closePopup();this.vPopup=ns.View.create("layout-switch-popup"),this.vPopup.open({where:this.$node.find(".js-content-toolbar-layout-switch"),how:{at:"bottom",my:"top+4"}}),ns.events.on("toolbar.fixed",this.onChangeToolbarPosition),this.vPopup.once("closed",this.offChangeToolbarPosition)},closePopup:function(){this.vPopup&&(this.vPopup.close(),this.vPopup=null)},onChangeToolbarPosition:function(t,e){e&&this.closePopup()},offChangeToolbarPosition:function(){ns.events.off("toolbar.fixed",this.onChangeToolbarPosition)}}})},2686:function(t,e){ns.View.define("layout-switch-popup",{events:{"ns-view-htmlinit":"initializeNanoislands","click .js-content-toolbar-layout-switch-popup-button":"onClickSwitchLayout"},models:{settings:{"ns-model-changed":!1}},yateModule:"toolbar",methods:{nbPopup:null,open:function(t){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopup=nb.block(this.node),this.nbPopup.open(t),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))},this)},close:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var t=this;_.defer(function(){t.nbPopup&&(t.trigger("closed"),t.nbPopup.destroy(),t.nbPopup=null),t.destroy()})},initializeNanoislands:function(){var t=nb.$block(".js-threaded-switch",this.$node);t.on("nb-checked",this._onClickMessagesThreaded.bind(this)),t.on("nb-unchecked",this._onClickMessagesThreaded.bind(this));var e=nb.$block(".js-bigger-text-switch",this.$node);e.on("nb-checked",this.switchBiggerText.bind(this)),e.on("nb-unchecked",this.switchBiggerText.bind(this));var o=nb.$block(".js-compact-mode-switch",this.$node);if(o){var n=this.switchCompactModeSettings.bind(this,"compact-mode");o.on("nb-checked",n),o.on("nb-unchecked",n)}var i=nb.$block(".js-compact-header-mode-switch",this.$node);if(i){var s=this.switchCompactModeSettings.bind(this,"compact-header-mode");i.on("nb-checked",s),i.on("nb-unchecked",s)}},onClickSwitchLayout:function(t){var e=$(t.currentTarget),o=e.data("layout");return this.switchLayout(o),!1},switchLayout:function(t){Daria.Config.layout!==t&&(this.nbPopup.close(),this.getModel("settings").setSettings({layout:Jane.LAYOUTS.indexOf(t)},function(){var t=_.clone(ns.page.current.params);delete t.ids,delete t.thread_id;var e;e=t.current_folder||t.current_label||t.goto||t.search?ns.router.generateUrl("messages",t):ns.page.getDefaultUrl(),ns.page.forceReload(e)}))},_onClickMessagesThreaded:function(){this.nbPopup.close();var t=ns.Model.get("settings");t.isThreaded()?t.threadedOff():t.threadedOn(),_.contains(["message","messages"],ns.page.current.page)&&ns.page.go(ns.router.generateUrl(ns.page.current.page,ns.page.current.params))},switchCompactModeSettings:function(t){if(t){var e=ns.Model.get("settings");this.nbPopup.close(),e.switchCompactModeSettings(t),$("html").toggleClass("mail-Page_minified",e.isCompactHeaderMode());var o=0===ns.page.currentUrl.indexOf("#categories");e.isCompactHeaderMode()&&o?ns.page.go("#inbox"):ns.page.go(),e.isCompactMode()&&e.isCompactHeaderMode()||setTimeout(function(){ns.events.trigger("head-tabs-recalculate")},300)}},switchBiggerText:function(){this.nbPopup.close();var t=ns.Model.get("settings");t.toggleSetting("with_bigger_text");var e=t.isSet("with_bigger_text");$("html").toggleClass("with-bigger-text",e),ns.events.trigger("daria:vMessagesPager:restruct"),ns.events.trigger("daria:vToolbarButton:restruct"),ns.events.trigger("head-tabs-recalculate")}}})},2687:function(t,e){!function(t){ns.View.define("toolbar",{models:{"scroller-messages":!1,toolbar:!1,settings:{"ns-model-changed":!1,"ns-model-changed.liza_minified":"onChangeCompactMode","ns-model-changed.liza_minified_header":"onChangeCompactMode"}},params:function(){return{layout:ns.page.current.page}},events:{"ns-view-init":"_onInit","ns-view-show":"_onShow","ns-view-hide":"_onHide","daria:vScrollerMessages:scroll@show":"_recalculateFixedPosition","daria:vApp:changeLeftColumWidth":"_recalculatePositionX","daria:vApp:changeRightColumSize":"_recalculatePositionX","daria:vToolbarAside:changeCheckedCount@show":"onChangeCheckedCount","toolbar-reset-offset":"_resetOffset","daria:layout-changed":"_resetOffset","click@show .js-toolbar-button-top":"onClickScrollToTop","daria:vMessageToolbar:reply":"onReply","daria:vMessagesItemWrap:message-opened":"onOpenMessage","daria:message-will-close@show":"onMessageWillClose"},yateModule:"toolbar",methods:{controlOffsetTop:null,_onInit:function(){this.getModel("toolbar").setFixedSupport(!0),this.isFixed=!1},_onShow:function(){this.getModel("scroller-messages").init();var t=this.getModel("toolbar"),e=t.get(".scroll");!1===t.get(".show")&&this.$node.addClass("is-hidden"),(void 0===e||e)&&(this._initScroll(!0),_.delay(this._recalculateFixedPosition.bind(this),50)),this._cancelSearchStoreSubscription=Daria.React.reactOnFoldedChange("Daria.vToolbar:searchIsFoldedSubscription",this.hideInCompactMode.bind(this)),this.hideInCompactMode()},_onHide:function(){this._cancelSearchStoreSubscription(),this._toggleFixed(!1)},_initScroll:function(e){this._hasCheckScroll=e,this.$nodeLabel=this.$node.find(".b-toolbar__item__label"),this.$nodeFixedPosition=this.$node.find(".js-toolbar-content"),t.watcher.watch("toolbar.allowfixed",this._recalculateFixedPosition.bind(this))},_getControlOffsetTop:function(){return this.$nodeLabel.length&&this.$nodeLabel[0].offsetHeight?this.$nodeLabel.offset().top:this.$node.offset().top},_recalculateFixedPosition:function(){if(!Daria.is3pane()&&this._hasCheckScroll){if(this.getModel("toolbar").getFixedSupport()){null===this.controlOffsetTop&&(this._toggleFixed(!1),this.controlOffsetTop=this._getControlOffsetTop());var t=this.getModel("scroller-messages").getScrollTop();if(this.controlOffsetTop-t<0&&(!this._isMessageOpen()||Daria.isMessagePage()))return void this._toggleFixed(!0)}this._toggleFixed(!1)}},_isMessageOpen:function(){var t=ns.page.current.params;return!(!t.thread_id&&!t.ids)&&(ns.events.trigger("daria:vToolbar:message-opened"),!0)},_recalculatePositionX:function(){if(!this.$nodeFixedPosition)return!1;var t={left:"",right:""};this.isFixed&&(t.left=this.$node.offset().left,t.right=$(window).width()-this.$node.outerWidth()-t.left),this.$nodeFixedPosition.css(t)},_toggleFixed:function(t){this.getModel("toolbar").toggleFixed(t)&&(t&&$(document).trigger("b-mail-dropdown-closeall-onscroll"),this.isFixed=t,this._recalculatePositionX(),this.$node.toggleClass("is-fixed",t),ns.events.trigger("toolbar.fixed",t))},_resetOffset:function(){this._hasCheckScroll&&(this.controlOffsetTop=null,_.defer(this._recalculateFixedPosition.bind(this)))},onClickScrollToTop:function(){this.getModel("scroller-messages").setScrollTop(0,!0)},onChangeCompactMode:function(){var t=this.getModel("settings");this._resetOffset(),this.hideInCompactMode(),this.$node.find(".js-toolbar-content").toggleClass("mail-Toolbar-Content_MessagesList_height_small",t.isCompactMode())},hideInCompactMode:function(){this.getModel("settings").isCompactHeaderMode()&&this.$node.find(".js-toolbar").toggleClass("is-hidden",!Daria.React.getSearchBoxIsFolded())},onChangeCheckedCount:function(t,e){this.$node.toggleClass("is-active",Boolean(e)),this.getModel("settings").isCompactHeaderMode()&&(e>0?Daria.React.getSearchBoxIsFolded()||(Daria.React.foldSuggest(!0),this.wasSuggestFoldBeforeToolbarOpened=!0):this.wasSuggestFoldBeforeToolbarOpened&&!0===this.wasSuggestFoldBeforeToolbarOpened&&Daria.isSearchPage()&&(this.wasSuggestFoldBeforeToolbarOpened=!1,Daria.React.foldSuggest(!1),Daria.React.showLastSearchQuery()))},isNewYear:function(){var t=Date.now(),e=-1!==["ru","uk","be","kk"].indexOf(Daria.locale),o="yandex.com"===Daria.Config["yandex-domain"];return t>=14821812e5&&t<=1483909199e3&&e&&!o},onOpenMessage:function(){this._toggleFixed(!1)},onMessageWillClose:function(){var t=this;_.delay(function(){t._recalculateFixedPosition()},150)},onMessagesCheckedChanged:function(){Daria.is3pane()},onReply:function(t,e){Daria.isMessagePage()&&this.onReplyHotkey(t,e)}}},"message-actions")}(Jane)},2688:function(t,e,o){!function(t){ns.View.define("toolbar-button",{events:{"ns-view-htmlinit":"_onHtmlInit","ns-view-show":"_onShow","ns-view-hide":"_onHide","click@show":"_onClick",drop:"_onDrop","daria:vToolbarButton:droppableInit@show":"_onDroppableInit","daria:vToolbarButton:droppableDestroy@show":"_onDroppableDestroy","daria:vToolbarButton:loader:end@show":"_disableLoader"},models:{"toolbar-button":!1,"messages-checked":!1},params:function(t){var e={id:t.id};return _.extend(ns.View.infoLite("toolbar-buttons").params(t),e)},yateModule:"toolbar",methods:{_wasDroppableInited:!1,_onHtmlInit:function(){this.initData()},_onShow:function(){this.droppableInit()},_onHide:function(){this.droppableDestroy()},invalidate:function(){return!1},initData:function(){var t=this.getModel("toolbar-button");this.action=t.get(".action"),this.disabledAction=t.get(".disabledAction"),this.actionParams=t.get(".actionParams"),_.isFunction(this.actionParams)&&(this.actionParams=this.actionParams(this.params))},_onDroppableInit:function(t,e){this.getId()===e&&this.droppableInit()},_onDroppableDestroy:function(t,e){this.getId()===e&&this.droppableDestroy()},_onDrop:function(t,e){ns.events.trigger("daria:vToolbarButton:onDrop",{id:this.getId(),event:t,dropParams:e})},droppableInit:function(){var t=this.getModel("toolbar-button");if(t.get(".droppable")){var e=t.get(".droppableParams");this.$node.droppable(e),this._wasDroppableInited=!0}},droppableDestroy:function(){this._wasDroppableInited&&(this._wasDroppableInited=!1,this.$node.droppable("destroy"))},_getActionParams:function(){return this.actionParams},_enableLoader:function(){this.getModel("toolbar-button").get(".disableLoader")},_disableLoader:function(){},_onClick:function(e,o){switch(o=o||ns.action.getParams(e.currentTarget),t.ToolbarMetric.setToolbarMetrics(e,o,this.prepareParamsForAction().buttonView.action,this.getCurrentMessageIfSingle()),this._enableLoader(),this.action){case null:case"mailbox.check":break;case"deselect":this.getCheckedModel().resetChecked();break;case"select-all":this.getCheckedModel().selectList();break;default:this.defaultAction(e)}return"mailbox.check"===this.action},defaultAction:function(){if(!this.enabled())return!1;var t=this.prepareParamsForAction(),e=this.getCheckedModel();if(Daria.DEBUG&&console.log("daria.vToolbarButton","runOps",this.action,t),_.contains(["forward","sendon","reply","reply-all","reply-tmpl"],this.action))return t.mMessagesChecked=e,void ns.action.run(this.action,t);var o=e.runOps(this.action,t),n=this.getModel("toolbar-button"),i=n.get(".callback");i&&"function"==typeof i&&o.then(i,this)},prepareParamsForAction:function(){return _.extend({buttonView:this,toolbar:1},this._getActionParams())},isVisible:function(){return!this.$node.hasClass("is-hidden")},getWidth:function(){return this.isVisible()?(this.getId()===Daria.Constants.TOOLBAR_BUTTONS.LABELS_ACTIONS&&(this._width=Math.floor(this.$node.outerWidth(!0))),this._width||(this._width=this.$node.outerWidth(!0)),this._width):0},resetButtonWidth:function(){delete this._width},enabled:no.True,getId:function(){return this.getModel("toolbar-button").get(".id")},getFolderIdFromParams:function(){var t=this.params.current_folder;return this.params.mid&&(t=ns.Model.get("message",{ids:this.params.mid}).getFolderId()),t},hide:function(t){t||this.isVisible()||ns.events.trigger("daria:vToolbarButton:restruct",this),this.$node.addClass("is-hidden")},show:function(t){!t&&this.isVisible()&&ns.events.trigger("daria:vToolbarButton:restruct",this),this.$node.removeClass("is-hidden")},toShow:function(){return this._canBeShown()&&(this._forceShown||this.getModel("toolbar-button").toShow())},getCheckedModel:function(){return this.getModel("messages-checked")},_canBeShown:function(){var t=this.getModel("toolbar-button"),e=this.getCheckedModel(),o=this.getId(),n=Daria.messages.canShowPinControlsByParams(),i=Daria.Constants.TOOLBAR_BUTTONS;return[i.DELETE_DRAFT,i.CHECK_MAIL,i.ABOOK_ADD,i.ABOOK_MORE].indexOf(o)>-1||!!e&&(!(!n&&this.isPinOrUnpin())&&t.toEnable())},isPinOrUnpin:function(){var t=this.getId();return t===Daria.Constants.TOOLBAR_BUTTONS.PIN||t===Daria.Constants.TOOLBAR_BUTTONS.UNPIN},canBeShownSelectOrDeselect:function(){var t=this.getId(),e=this.getCheckedModel(),o=e.shouldSelectAll();if("select-all"===t)return o;if("deselect"===t){var n=e.getCount();return!o||n>4}return!1},select:function(){this.$node.find(".js-toolbar-button").addClass("b-toolbar__item_selected")},deselect:function(){this.$node.find(".js-toolbar-button").removeClass("b-toolbar__item_selected")},forceShow:function(t){this._forceShown=t,this._canBeShown()?this.show():this.hide()},triggerClick:function(t,e){return this._onClick(t,e)},_runAction:function(t){ns.action.run(this.action,{},t.currentTarget,t)},isSpecial:function(){return Boolean(this.getModel("toolbar-button").get(".special"))},getCurrentMessageIfSingle:function(){var t=this.getModel("messages-checked");if(!t)return null;var e=t.getIds();if(e&&0===e.tids.length&&1===e.ids.length){return ns.Model.get("messages",ns.page.current.params).getMessageByMid(e.ids[0])}return null}}}),o(2689),o(2690),o(2691),o(2692),o(2693),o(2694),o(2695),o(2696),o(2697),o(2698),o(2699),o(2700),o(2701),o(2702),o(2703),o(2704),o(2705),o(2706),o(2707),o(2708),o(2709),o(2710),o(2711),o(2712),o(2713),o(2714),o(2715),o(2716),o(2717),o(2718),o(2719),o(2723),o(2724),o(2725),o(2726),o(2727)}(Jane)},2689:function(t,e){ns.View.edefine("toolbar-button-abook",{events:{"daria:vAbookContacts:selectionChanged":"onSelectionChanged","ns-page-after-load":"_toggleSelectAllState"},models:{"toolbar-button":!1,"abook-selected":!1},params:function(t){var e={id:t.id,type:t.type};return _.extend(ns.View.infoLite("toolbar-buttons").params(t),e)},yateModule:"toolbar",methods:{_toggleSelectAllState:function(){if(this.getId()===Daria.Constants.TOOLBAR_BUTTONS.ABOOK_SELECT_ALL){var t=this.getCheckedModel(),e=t.isEmptyContactsList();this.$node.toggleClass("is-disabled",e)}},getCheckedModel:function(){return this.getModel("abook-selected")},onSelectionChanged:function(t,e){var o=this.getModel("toolbar-button").getData().id;_.has(e,o)&&(this.__toShow=Boolean(e[o]))},toShow:function(){var t=this.getId(),e=[Daria.Constants.TOOLBAR_BUTTONS.ABOOK_SELECT_ALL,Daria.Constants.TOOLBAR_BUTTONS.ABOOK_DESELECT_ALL].indexOf(t)>-1,o=1===this.params.shared,n=this.getCheckedModel().containsShared();return!((o||n)&&!e)&&([Daria.Constants.TOOLBAR_BUTTONS.ABOOK_ADD,Daria.Constants.TOOLBAR_BUTTONS.ABOOK_RESTORE,Daria.Constants.TOOLBAR_BUTTONS.ABOOK_MORE].indexOf(t)>-1||(t===Daria.Constants.TOOLBAR_BUTTONS.ABOOK_SELECT_ALL&&void 0===this.__toShow||this.__toShow))}}},"toolbar-button")},2690:function(t,e){ns.View.edefine("toolbar-button-check-mail",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{_onClick:function(t){return Jane.ToolbarMetric.tb(this.prepareParamsForAction()),this._runAction(t),!1}}},"toolbar-button")},2691:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button").methods;ns.View.edefine("toolbar-button-hybrid-abstract",{yateModule:"toolbar",methods:{_onHtmlInit:function(){t._onHtmlInit.call(this),this.folderAction=this.getModel("toolbar-button").get(".folderAction")},_onClick:function(t,e){e=e||ns.action.getParams(t.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(t,e,this.prepareParamsForAction().buttonView.action,this.getCurrentMessageIfSingle()),this._enableLoader(),this.defaultAction()},toShow:function(){return!(!this.folderAction||!this.getModel("messages-checked").isFolderSelected())||t.toShow.call(this)}}},"toolbar-button")}()},2692:function(t,e){!function(){var t=null,e=!1,o=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-disable-in",{events:{"daria:vMessage:message-body-loaded":"_onMessagesBodyLoaded"},models:o.models,params:o.params,yateModule:"toolbar",methods:{_onMessagesBodyLoaded:function(){},toShow:function(){if(this.params.mid){if(ns.Model.get("message-body",{ids:this.params.mid}).isLoaded()&&!this.toEnableExtended())return!1}return o.methods.toShow.call(this)},toEnableExtended:no.true,toEnableInCollectMessage:function(){if(this.params.mid){return!ns.Model.get("message-body",{ids:this.params.mid}).isCollectorMessage()}return!0},toEnableInNotificationMessage:function(){if(this.params.mid){if(!e){e=!0;var o=ns.Model.get("labels").getLabelByName("SystMetkaWJDT:NOTIFY");o&&(t=o.id)}if(t){if(ns.Model.get("message",{ids:this.params.mid}).hasLabel(t))return!1}}return!0}}},"toolbar-button")}()},2693:function(t,e){ns.View.define("toolbar-button-disabled",{yateModule:"toolbar",methods:{enabled:function(){var t=this.getCheckedModel();return t.getCount()||t.isFolderSelected()},toggleEnabled:function(t,e){var o=void 0===e?this.enabled():e;this.$node.toggleClass("is-disabled",!o)}}})},2694:function(t,e){!function(){ns.View.edefine("toolbar-button-main-select-all",{events:{"ns-view-show":"toggleDisablement"},models:{"toolbar-button":!1,"messages-checked":{"ns-model-touched":"onMessagesCheckedTouched"},settings:{"ns-model-changed":!1,"ns-model-changed.show_checkbox_inside_userpic":"onSettingChange"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{invalidate:ns.View.prototype.invalidate,onMessagesCheckedTouched:function(){this.toggleDisablement()},onSettingChange:function(){this.invalidate()},toggleDisablement:function(){var t=this.getCheckedModel(),e=t.isEmptyMessagesList(),o=!e&&t.isPinnedMessagesList(),n=e||o;this.isDisabled=n,this.$node.toggleClass("is-disabled",n)},toShow:function(){return this.getCheckedModel().shouldSelectAll()},_onClick:function(){if(this.isDisabled)return!1;var t=this.getCheckedModel();t.resetChecked(),t.selectList(!0),t.trigger("ns-model-reset-checked")}}},"toolbar-button-disable-in","toolbar-button-hybrid-abstract")}()},2695:function(t,e){!function(){ns.View.edefine("toolbar-button-main-deselect-all",{models:{"toolbar-button":!1,"messages-checked":!1,settings:{"ns-model-changed":!1,"ns-model-changed.show_checkbox_inside_userpic":"onSettingChange"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{invalidate:ns.View.prototype.invalidate,onSettingChange:function(){this.invalidate()},toShow:function(){return!this.getCheckedModel().shouldSelectAll()},_onClick:function(){this.getCheckedModel().resetChecked()}}},"toolbar-button-disable-in","toolbar-button-hybrid-abstract")}()},2696:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-reply",{models:t.models,params:t.params,yateModule:"toolbar",methods:{toEnableExtended:function(){return this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()}}},"toolbar-button-disable-in")}()},2697:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-edit",{models:t.models,params:t.params,yateModule:"toolbar"},"toolbar-button-disable-in")}()},2698:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-forward",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:t.params,yateModule:"toolbar",methods:{enabled:function(){var t=this.getModel("messages-checked").getCount();return t>0&&t<=Daria.Constants.MAX_MESSAGES_TO_FORWARD},toEnableExtended:function(){return this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()}}},"toolbar-button-disabled","toolbar-button-disable-in")}()},2699:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button"),e=ns.View.infoLite("toolbar-button-disable-in");ns.View.edefine("toolbar-button-spam",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:t.params,yateModule:"toolbar",methods:{toShow:function(){var t=!1,o=this.getFolderIdFromParams();if(o){var n=ns.Model.get("folders");if(n.isFolder(o,["sent","draft","template"]))return!1;t=n.isFolder(o,["spam"])}return!t&&e.methods.toShow.apply(this,arguments)},toEnableExtended:function(){return this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()}}},"toolbar-button-disabled","toolbar-button-disable-in")}()},2700:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button-spam"),e=ns.View.infoLite("toolbar-button-disable-in");ns.View.edefine("toolbar-button-not-spam",{models:t.models,params:t.params,yateModule:"toolbar",methods:{toShow:function(){var t=!1,o=this.getFolderIdFromParams();return o&&(t=ns.Model.get("folders").isFolder(o,["spam"])),t&&e.methods.toShow.apply(this,arguments)}}},"toolbar-button-spam")}()},2701:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button-hybrid-abstract").methods;ns.View.edefine("toolbar-button-pin",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){var e=this.getFolderIdFromParams();return(!e||!ns.Model.get("folders").isFolder(e,["spam"]))&&(!!t.toShow.call(this)&&!this.getCheckedModel().hasPinnedCheckedMessage())}}},"toolbar-button-disabled","toolbar-button-disable-in","toolbar-button-hybrid-abstract")}()},2702:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button-hybrid-abstract").methods;ns.View.edefine("toolbar-button-unpin",{models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){var e=this.getFolderIdFromParams();return(!e||!ns.Model.get("folders").isFolder(e,["spam"]))&&(!!t.toShow.call(this)&&this.getCheckedModel().hasPinnedCheckedMessage())}}},"toolbar-button-disable-in","toolbar-button-hybrid-abstract")}()},2703:function(t,e){var o="toolbar-button-hybrid-abstract",n=ns.View.infoLite(o).methods,i=ns.View.infoLite("toolbar-button-disable-in").methods;ns.View.edefine("toolbar-button-mark-as-read",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){if(this._forceShown)return!0;var t=this.getCheckedModel();if(t.isFolderSelected()){var e=t.getFolders(),o=ns.Model.get("folders"),s=!1;for(var a in e)if(e[a]>0&&o.getUnreadCount(a)>0){s=!0;break}if(!s)return!1}else{if(!i.toShow.call(this))return!1;if(!n.toShow.call(this))return!1}return!ns.Model.get("folders").isCurrentFolder("template")&&(!!t.isFolderSelected()||!t.areAllCheckedRead())},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},"toolbar-button-disabled","toolbar-button-disable-in",o)},2704:function(t,e){!function(){var t="toolbar-button-hybrid-abstract",e=ns.View.infoLite(t).methods;ns.View.edefine("toolbar-button-mark-as-unread",{models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){if(this._forceShown)return!0;if(ns.Model.get("folders").isCurrentFolder("template"))return!1;var t=this.getCheckedModel();return!!t.getCount()&&(!!e.toShow.call(this)&&t.areAllCheckedRead())},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},"toolbar-button-disable-in",t)}()},2705:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-delete",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:t.params,yateModule:"toolbar"},"toolbar-button-disabled","toolbar-button-hybrid-abstract")}()},2706:function(t,e){ns.View.edefine("toolbar-button-more",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:{id:null},yateModule:"toolbar",methods:{_onHtmlInit:function(){this.initData()},_onShow:function(){this.initNb()},_onHide:function(){this.nbPopup.destroy()},initNb:function(){this.nbPopupToggler=nb.block(this.node),this.nbPopup=nb.$block(".js-main-toolbar-more-menu"),this.nbPopup.on("nb-select",this.onMenuItemClick.bind(this))},closeExtendButtons:function(){this.$extend&&(this.$extend.remove(),this.$extend=null,Daria.Dropdown.closeCurrent())},toShow:function(){return _.any(this._extendButtonViews,function(t){return t.toShow()})},setExtendButtons:function(t){var e=t.map(function(t){return t.getId()});this._extendButtons=t.map(function(t){return t.getModel("toolbar-button")}),this._extendButtonViews=t,Jane.watcher.set("toolbar.buttons.extend",e.join(","))},_onClick:function(t){return this.enabled()?(_.delay(function(){var t=this._extendButtons.map(function(t){return _.assign({},t.getData(),t.getExData())}),e=Jane.tt("toolbar:toolbar-button-more-menu-content",{popupMenu:{menu:t}});this.nbPopup.setContent(e),this.nbPopupToggler.open()}.bind(this)),!1):(t.stopPropagation(),!1)},onMenuItemClick:function(t,e){var o=e.ui.item,n=o.children("a").data("id"),i=Daria.Constants.TOOLBAR_BUTTONS;if(n){var s=_.find(this._extendButtonViews,function(t){return t.getId()===n});if(s){n!==i.LABELS_ACTIONS&&n!==i.FOLDERS_ACTIONS&&this.nbPopupToggler.close();var a={isInMore:!0},r=ns.action.getParams(o.children("a")[0]);r&&r.source&&(a.source=r.source),s.triggerClick(e.event,a)}}}}},"toolbar-button-disabled","toolbar-button")},2707:function(t,e){!function(){var t="toolbar-button-disable-in",e=ns.View.infoLite(t);ns.View.edefine("toolbar-button-reply-all",{events:{"daria:vMessage:message-body-loaded":"_onMessagesBodyLoaded"},models:e.models,params:e.params,yateModule:"toolbar",methods:{_onMessagesBodyLoaded:function(){e.methods._onMessagesBodyLoaded.call(this)},toEnableExtended:function(){var t=ns.Model.get("message-body",{ids:this.params.mid});return t.isLoaded()&&t.allowedReplyAll()&&this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()}}},t)}()},2708:function(t,e){!function(){ns.View.edefine("toolbar-button-unsubscribe",{models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){var t=this.getCheckedModel();if("messages"===ns.page.current.page&&1!==t.getCount())return!1;var e=t.getIds();if(!e.ids.length)return!1;var o=e.ids[0],n=ns.Model.get("message",{ids:o});if(n.inFolderBySymbol(["sent","draft","spam"]))return!1;var i=ns.Model.get("message-body",{ids:o});return!n.isSpam()&&(i.hasListUnsubscribe()||i.hasFactUnsubscribe())}}},"toolbar-button-reply-all")}()},2709:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button").methods;ns.View.edefine("toolbar-button-customizable-abstract",{yateModule:"toolbar",methods:{runButtonAction:function(){if(this.toShowWithSettings()){var t=$.Event("click",{target:this.node});this.triggerClick(t)}},toShow:function(){var t=this.getSettingsKey();if(this._forceShown)return!0;if(this._lazyInitToolbarSettingsModel(),!this.mToolbarSettings||!this.mToolbarSettings.get(t))return!1;var e=this.getModel("messages-checked").isFolderSelected();return this.getId()!==Daria.Constants.TOOLBAR_BUTTONS.TEMPLATE||!e&&this.toShowWithSettings()},toShowWithSettings:function(){ns.assert(null,"vToolbarButtonCustomizableAbstract","%s coundn't be called directly. It's abstract")},show:function(){t.show.apply(this,arguments)},_lazyInitToolbarSettingsModel:function(){this._toolbarSettingsModelInitDone||(this._toolbarSettingsModelInitDone=!0,this.mToolbar=ns.Model.get("toolbar",{layout:ns.page.current.page}),this.mToolbar&&this.mToolbar.areSettingsEnabled()&&this.getModel("toolbar-button").isModelWithSettings()&&(this.mToolbarSettings=Daria.userToolbar))},_getActionParams:function(){return this._lazyInitToolbarSettingsModel(),_.clone(this.mToolbarSettings.get(this.getSettingsKey()).settings)},getSettingsKey:function(){return this.getId()},updateName:_.noop}},"toolbar-button")}()},2710:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button-customizable-abstract").methods;ns.View.edefine("toolbar-button-with-customizable-name",{events:{"daria:vToolbarButton:updateName":"updateName"},yateModule:"toolbar",methods:{toShow:function(){return t.toShow.apply(this,arguments)},show:function(){this.updateName(),t.show.apply(this,arguments)},updateName:function(){var t=this.mToolbarSettings.getCustomizableButtonName(this.getId());t&&this.getModel("toolbar-button").setName(t)},redrawName:function(){var t=this.getModel("toolbar-button").get(".name");this.$node.find(".js-toolbar-item-title").text(t)}}},"toolbar-button-customizable-abstract")}()},2711:function(t,e){ns.View.edefine("toolbar-button-archive",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){var t=ns.Model.get("folders"),e=this.getFolderIdFromParams();return!e||!t.isArchive(e)}}},"toolbar-button-disabled","toolbar-button-customizable-abstract")},2712:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button-disable-in"),e=ns.View.infoLite("toolbar-button-with-customizable-name");ns.View.edefine("toolbar-button-sendon",{events:{"daria:vToolbarButtonSendOn:doForward@show":"runButtonAction"},models:{"toolbar-button":{"ns-model-changed":"keepValid","ns-model-changed.name":"redrawName"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){return this.getCheckedModel().getCount()>0},toShow:function(){if(e.methods.toShow.call(this))return t.methods.toShow.call(this)},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},"toolbar-button-disabled","toolbar-button-disable-in","toolbar-button-with-customizable-name")}()},2713:function(t,e){ns.View.edefine("toolbar-button-infolder",{models:{"toolbar-button":{"ns-model-changed":"keepValid","ns-model-changed.name":"redrawName"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){var t=this.getFolderIdFromParams();if(Daria.IS_CORP&&ns.Model.get("folders").isShared(t))return!1;if(t&&t===jpath(this.mToolbarSettings.get(this.getId()),".settings.folder")[0])return!1;var e=this.getCheckedModel();return e.getCount()>0&&!e.isFolderSelected()}}},"toolbar-button-disabled","toolbar-button-with-customizable-name")},2714:function(t,e){ns.View.edefine("toolbar-button-label",{models:{"toolbar-button":{"ns-model-changed":"keepValid","ns-model-changed.name":"redrawName"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(t){t=t||this.getId();var e=this.mToolbarSettings.get(t),o=this.getCheckedModel(),n=e.settings.label,i=o.getIds("label",{lid:n});return i.ids.length+i.tids.length>0}}},"toolbar-button-disabled","toolbar-button-with-customizable-name")},2715:function(t,e){ns.events.on("pageinit",function(){ns.events.on("daria:mComposeMessage:template-saved",function(t,e){var o=Daria.Constants.TOOLBAR_BUTTONS.TEMPLATE;if(e.oldMid&&e.mid){var n=Daria.userToolbar.get(o);n&&n.settings.tmpl===e.oldMid&&(n.settings.tmpl=e.mid,Daria.userToolbar.set())}})});var o=ns.View.infoLite("toolbar-button-disable-in"),n=ns.View.infoLite("toolbar-button-customizable-abstract");ns.View.edefine("toolbar-button-template",{events:{"daria:vToolbarButtonTemplate:doSendAutoReplay@show":"runButtonAction"},models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){if(!this.mToolbarSettings.get(this.getId()))return!1;var t=this.getCheckedModel();if("messages"===ns.page.current.page&&1!==t.getCount())return!1;var e=t.getIds("template");return!(!e.ids.length&&!e.tids.length)},toShow:function(){if(n.methods.toShow.call(this))return o.methods.toShow.call(this)},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},"toolbar-button-disable-in","toolbar-button-customizable-abstract")},2716:function(t,e){ns.View.edefine("toolbar-button-add-template",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShow:function(){return ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,["draft","template"])},_onClick:function(){return ns.Model.get("compose-predefined-data").setData({save_symbol:"template"}),ns.page.go(ns.router.generateUrl("compose2")),!1}}},"toolbar-button")},2717:function(t,e){ns.View.edefine("toolbar-button-toolbar-settings",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShow:function(){return!0},_onClick:function(t){ns.events.trigger("daria:vToolbar:customize"),ns.events.trigger("daria:vToolbar:action",{action:"customize"}),Jane.Services.run("#setup",function(){ns.events.trigger("daria:vToolbarButton:updateName");var e=ns.View.create("toolbar-settings");e.update().then(function(){var o=void 0;o=t?$(t.target).closest(".js-toolbar-item"):this.$node.closest(".js-toolbar-item")||this.$node.find(".js-toolbar-item"),e.showPopup(o)}.bind(this)),"toolbar-settings"===this.getId()&&Jane.ToolbarMetric.ub("клик на шестеренку")}.bind(this))}}},"toolbar-button-customizable-abstract")},2718:function(t,e){ns.View.edefine("toolbar-button-add-button",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShowWithSettings:function(){return!Daria.Config.NO_SETTINGS&&!this.mToolbarSettings.isActivated()},_onClick:function(){this.super_._onClick.apply(this,arguments),Jane.ToolbarMetric.ub('клик на предложение "Добавить"')}}},"toolbar-button-toolbar-settings")},2719:function(t,e,o){ns.View.edefine("toolbar-button-compose",{events:{"compose.open.change":"_onComposeOpenChange"},models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShow:function(){return Boolean(Jane.watcher.get("compose.open"))&&this.getModel("toolbar-button").toEnable()},_onComposeOpenChange:function(){},_onClick:function(t){return"compose.remove"===this.action?ns.events.trigger("daria:vToolbarButton:"+this.action):this._runAction(t),!1}}},"toolbar-button"),o(2720),o(2721),o(2722)},2720:function(t,e){ns.View.edefine("toolbar-button-compose-go",{models:{"toolbar-button":!1,settings:!1},params:{id:null},yateModule:"toolbar",methods:{_onClick:function(){Jane.ToolbarMetric.tb(this.prepareParamsForAction())},toShow:function(){return"compose2"!==ns.page.current.page}}},"toolbar-button")},2721:function(t,e){ns.View.edefine("toolbar-button-compose-special",{events:{"daria:vToolbarButton:switchType":"_onSwitchType"},models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{_onSwitchType:function(t,e){this[e.type&&e.type===this.getModel("toolbar-button").getType()?"select":"deselect"]()},_onClick:function(){var t=this.getModel("toolbar-button"),e=t.getType();return ns.events.trigger("daria:vToolbarButton:"+e,{buttonView:this}),ns.events.trigger("daria:vToolbarButton:switchType",{buttonView:this,type:e}),!1}}},"toolbar-button-compose")},2722:function(t,e){ns.View.edefine("toolbar-button-compose-abook",{models:{"toolbar-button":!1,"abook-selected":!1},params:function(t){var e={id:t.id,type:t.type};return _.extend(ns.View.infoLite("toolbar-buttons").params(t),e)},yateModule:"toolbar",methods:{toShow:function(){return ns.Model.get("settings").isCompactHeaderMode()&&!Daria.isComposeButtonMoved()}}},"toolbar-button-abook")},2723:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-translate",{models:t.models,params:t.params,yateModule:"toolbar",methods:{isMore:no.True,_onClick:function(t,e){e=e||ns.action.getParams(t.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(t,e,"translate",this.getCurrentMessageIfSingle()),ns.Model.get("message-widget-state",{ids:ns.page.current.params.ids}).show("message-widget-translate")}}},"toolbar-button-disable-in")}()},2724:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-print",{models:t.models,params:t.params,yateModule:"toolbar",methods:{_onClick:function(t,e){e=e||ns.action.getParams(t.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(t,e,"print",this.getCurrentMessageIfSingle())},isMore:no.True}},"toolbar-button-disable-in")}()},2725:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-filters-create",{models:t.models,params:t.params,yateModule:"toolbar",methods:{_onClick:function(t,e){e=e||ns.action.getParams(t.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(t,e,"filters-create")},isMore:no.True}},"toolbar-button-disable-in")}()},2726:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-message-source",{models:t.models,params:t.params,yateModule:"toolbar",methods:{_onClick:function(t,e){e=e||ns.action.getParams(t.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(t,e,"message-source",this.getCurrentMessageIfSingle())},isMore:no.True}},"toolbar-button-disable-in")}()},2727:function(t,e){!function(t){var e,o={};e=Modernizr.mozilla?["click","keyup"]:["change"],_.each(e,function(t){o[t+"@show .js-toolbar-settings-button-options-select"]="_onButtonOptionsSelectChange"}),ns.View.define("toolbar-settings",{events:_.extend(o,{"ns-view-init":"_onInit","label.filter.toggle":"resizeDialog","scroll@show window":"_onScrollWindow","resize@show window":"_onResizeWindow","click@show .js-clickable":"_onClick",'keyup@show .js-toolbar-settings-button-options-select,input[type="text"]':"_onButtonOptionsSelectEnter","focus@show .js-toolbar-settings-button-options-email":"_onButtonOptionsEmailFocus"}),models:{settings:!1,toolbar:!1},params:function(){return{layout:ns.page.current.page}},yateModule:"toolbar",methods:{_onInit:function(){this.mToolbarSettings=Daria.userToolbar,this.POPUP_WIDTH=750,this._locked=!1,this._$handle=null,this._handleOffset=null,this._dialog=null,this._dialogOffset=null,this._currentButtonIdEditing=null,this._$buttonOptionsForm=null},getSettings:function(){return this.mToolbarSettings.get()},showPopup:function(t){this._$window&&this._$window.length||(this._$window=$(window)),this._$handle=t,this._handleOffset=t.offset(),this._dialog=Daria.Dialog.open({body:this.$node,width:this.POPUP_WIDTH,easyclose:!1,hideCrossClose:!0,additionalClass:"b-toolbar-settings",onTarget:{side:"top",pos:"bottom",x:this.getPopupLeftPosition(),y:this.getPopupTopPosition()-this._$window.scrollTop(),needTail:!1},onopen:this.onPopupOpen.bind(this),oncancel:this.onPopupCancel.bind(this),onclose:this.onPopupClose.bind(this)}),this._dialog.resize=function(t){var e=t?this.$body.find(".js-toolbar-settings-form"):this.$body.find(".js-toolbar-settings");this.$body.height(e.height())},this.isActivated()||this.mToolbarSettings.activate().done(function(){ns.events.trigger("daria:vToolbarButtons:settingsActivated"),ns.events.trigger("daria:vToolbarButton:restruct")})},isActivated:function(){return this.mToolbarSettings.isActivated()},onPopupOpen:function(t){this._dialog=t,t.$paranja.removeClass("g-hidden"),t.$dialog.removeClass("b-popup_contextual"),t.$dialog.find("input").filter(":visible").eq(0).focus(),this._dialogOffset=t.$dialog.offset(),this._dialogOffset.top=this._dialogOffset.top-this._$window.scrollTop()},onPopupCancel:function(){this.mToolbarSettings.invalidateCache(),ns.events.trigger("daria:vToolbarSettings:canceled"),t.ToolbarMetric.ub(["настройки",'клик на "Отменить"'])},onPopupClose:function(t){this._dialog.autocompleter&&(this._dialog.autocompleter.hide(),this._dialog.autocompleter.destroy()),this._$handle=null,this._handleOffset=null,this._dialog=null,this._dialogOffset=null,this._currentButtonIdEditing=null,this._$buttonOptionsForm=null,t.$paranja.addClass("g-hidden"),ns.events.trigger("daria:vToolbarSettings:popupClosed"),this.destroy()},getPopupLeftPosition:function(){var t=this._$handle.outerWidth(),e=this._handleOffset.left+t/2,o=this.POPUP_WIDTH/2,n=$(".js-mail-layout"),i=n.width(),s=n.offset().left,a=s+i,r=e;return s>e-o?r=o+s+2:e+o>a&&(r=a-o+2),r},getPopupTopPosition:function(){return this._handleOffset.top+this._$handle.outerHeight()},_onClick:function(t){var e=$(t.currentTarget),o=ns.action.getParams(e[0]);switch(e.data("clickAction")){case"toolbar.settings.button.toggle":this._onButtonToggle(e,o);break;case"toolbar.settings.button.options":this._onButtonEditOptions(o);break;case"toolbar.settings.submitButtonOptions":this._onSubmitButtonOptions(o);break;case"toolbar.settings.submit":this._onSubmit();break;case"toolbar.settings.back":this._onBack(o)}return!1},deactivateButton:function(e,o){var n=this.getModel("toolbar").getById(e);return this._markButtonDeactivated(o),n.resetName(),t.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"снять выбор"]),this.mToolbarSettings.deactivateButton(e)},_markButtonDeactivated:function(t){t.removeClass("b-mail-button_filter-selected").find(".js-toolbar-item-title").text(t.data("title"))},activateButton:function(e,o){var n=this.getModel("toolbar").getById(e);if(t.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"выбор"]),_.isEmpty(n.get(".settings")))return this._markButtonActivated(o),this.mToolbarSettings.activateButton(e,n.get(".settings"));this.startButtonOptionsEditing(e,n)},_markButtonActivated:function(t,e){t.addClass("b-mail-button_filter-selected").find(".js-toolbar-item-title").text(e)},_onButtonToggle:function(t,e){if(!this.isLocked()){var o=e.button,n=this.mToolbarSettings.isButtonActivated(o),i=null;i=n?this.deactivateButton(o,t):this.activateButton(o,t),this.unlock(),_.isArray(i)&&ns.events.trigger("daria:vToolbarSettings:buttonToggled")}},startButtonOptionsEditing:function(t,e){_.isUndefined(e)&&(e=this.getModel("toolbar").getById(t)),this._currentButtonIdEditing=t,e.getSettingsDepsParams().then(function(o){var n=Vow.fulfill({}),i=e.get(".settingsDeps");_.isEmpty(i)||(n=ns.request(i,o)),n.then(function(){this.showButtonOptionsForm(t,e,o)}.bind(this))}.bind(this),this.showButtonOptionsForm.bind(this,t,e))},_onButtonEditOptions:function(t){this.startButtonOptionsEditing(t.button)},showButtonOptionsForm:function(e,o,n){n=n||{},n.isLocked=this.isLocked();var i=this._dialog.$body,s=i.outerWidth(),a=this.mToolbarSettings.get(e)||{},r=_.extend({},{params:n,button:_.extend({},a,{id:e})});this._$buttonOptionsForm=$(t.tt("toolbar:js-toolbar-settings-button-options-form",r,o.get(".settingsDeps"),n)),this.$node.remove(".js-toolbar-settings-form").append(this._$buttonOptionsForm.addClass("g-vhidden")),i.width(s),Daria.setZeroTimeout(function(){this._$buttonOptionsForm.removeClass("g-vhidden")}.bind(this)),this.$node.find(".js-toolbar-settings").animate({marginLeft:0-s},{complete:function(){this._dialog.resize(!0),this._getButtonOptionsFormControls().filter(":visible").eq(0).focus()}.bind(this)}),t.ToolbarMetric.ub(["настройки","клик на "+o.get(".action"),"настройки","показ"])},_getButtonOptionsFormControls:function(){return this._$buttonOptionsForm.find('input[type="text"], select, textarea')},_onButtonOptionsSelectChange:function(t){this._$buttonOptionsForm.find(".js-toolbar-settings-error").addClass("g-hidden");var e=$(t.currentTarget),o=e.attr("name"),n=e.val(),i=this._$buttonOptionsForm.find(".js-toolbar-settings-"+o+"-edit");if("new"===n&&i.hasClass("g-hidden")){switch(i.removeClass("g-hidden"),o){case"label":this._dialog.labelCreate=Daria.LabelCreateContext({parent:i,hotkey:!1}),this._dialog.labelCreate.init();break;case"folder":this._dialog.folderCreate=Daria.FolderCreateContext({parent:i,hotkey:!1}),this._dialog.folderCreate.init()}this._focusNextFormControl(e)}else"new"!==n&&i.addClass("g-hidden");this._dialog.resize(!0)},_onButtonOptionsSelectEnter:function(e){if(e.keyCode!==t.Common.keyCode.ENTER)return!0;var o=$(e.currentTarget);return this._focusNextFormControl(o).fail(function(){this._onSubmitButtonOptions({button:this._currentButtonIdEditing})}.bind(this)),!1},_focusNextFormControl:function(t){var e=new Vow.Promise,o=this._getButtonOptionsFormControls(),n=o.filter(":visible").slice(o.index(t)+1).eq(0);return n.length?(n.focus(),e.fulfill()):e.reject(),e},_onButtonOptionsEmailFocus:function(t){var e=t.currentTarget;this._dialog.autocompleter=Daria.Autocompleter.getContactEmail(),this._dialog.autocompleter.bindField({field:e,focus:1,currentValue:$(e).val()})},_onSubmitButtonOptions:function(e){if(!this.isLocked()){this.lock();var o=e.button,n=this.getModel("toolbar").getById(o),i={};_.each(n.get(".settings"),function(t,e){i[e]=this._$buttonOptionsForm.find('[name="'+e+'"]').val()}.bind(this));var s=new Vow.Promise,a=n.validateSettings(i),r=this._$buttonOptionsForm.find(".js-toolbar-settings-loader"),l=this._$buttonOptionsForm.find(".js-toolbar-settings-error");l.addClass("g-hidden"),r.removeClass("g-hidden"),_.isEmpty(a)?s.sync(this._createContainerIfNeeded(o,i)):s.reject(),s.always(function(t){return r.addClass("g-hidden"),this.unlock(),t}.bind(this)).then(function(){this.mToolbarSettings.activateButton(o,i);var e=this.$node.find(".js-toolbar-settings-button-"+o),s=this.mToolbarSettings.getCustomizableButtonName(o);this._markButtonActivated(e,s),ns.events.trigger("daria:vToolbarSettings:buttonOptionsChanged"),this._onBack(),t.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"настройки","применить"])}.bind(this),function(e){_.isString(e)&&a.push(e),l.each(function(){var t=$(this),e=t.data("errors");e&&_.intersection(a,e.split(" ")).length&&t.removeClass("g-hidden")}),this._dialog.resize(!0),t.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"настройки","ошибка"])}.bind(this))}},_createContainerIfNeeded:function(t,e){var o=new Vow.Promise;if(t===Daria.Constants.TOOLBAR_BUTTONS.TEMPLATE)if("new"===e.tmpl){e.tmpl=null;var n=(this._$buttonOptionsForm.find('[name="body"]').val()||"").trim();n?this._createNewTemplate(n).then(function(t){e.tmpl=t,ns.page.go().always(function(){o.fulfill()})},function(){o.reject("template_body_save")}):o.reject("template_body_empty")}else o.fulfill();else t===Daria.Constants.TOOLBAR_BUTTONS.LABEL?"new"===e.label?(e.label=null,this._dialog.labelCreate.onCreate().then(function(t){e.label=t,ns.page.go().always(function(){o.fulfill()})},function(){o.reject("label_edit"),ns.events.once("label.error.hide",function(){this._dialog.resize(!0)}.bind(this))})):o.fulfill():t===Daria.Constants.TOOLBAR_BUTTONS.INFOLDER&&"new"===e.folder?(e.folder=null,this._dialog.folderCreate.onCreate().then(function(t){e.folder=t,o.fulfill()},function(){o.reject("folder_edit"),ns.events.once("folder.error.hide",function(){this._dialog.resize(!0)}.bind(this))})):o.fulfill();return o},_onSubmit:function(){if(!this.isLocked()){this.lock();var e=this.$node.find(".js-toolbar-settings-main-loader");e.removeClass("g-hidden"),this.save().then(function(){t.ToolbarMetric.ub(["настройки",'клик на "Готово"'])},this).always(function(){this.unlock(),e.addClass("g-hidden")},this).then(function(){this._dialog.close()},this)}},_onBack:function(e){if(!this.isLocked()){var o=function(){this._$buttonOptionsForm.remove(),this._dialog.resize(!1),this.$node.find("input").filter(":visible").eq(0).focus()}.bind(this);if(this.$node.find(".js-toolbar-settings").animate({marginLeft:0},{always:o}),e&&e.button){var n=this.getModel("toolbar").getById(e.button);t.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"настройки","назад"])}this._currentButtonIdEditing=null}},resizeDialog:function(){this._dialog&&this._dialog.resize(!0)},_onResizeWindow:_.debounce(function(){this._dialog&&(this._dialog.$dialog.offset({left:this.getPopupLeftPosition()-this.POPUP_WIDTH/2}),this._animateDialogPosition(),this._dialog.autocompleter&&this._dialog.autocompleter.hide())},200,{trailing:!0}),_onScrollWindow:_.throttle(function(){this._dialog&&(this._animateDialogPosition(),this._dialog.autocompleter&&this._dialog.autocompleter.hide())},50,{trailing:!0}),_animateDialogPosition:function(){this._dialog.$dialog.animate({top:this._dialogOffset.top+this._$window.scrollTop()},{queue:!1})},lock:function(){return t.disableButton(this.$node.find(".js-toolbar-settings-control")),this._locked=!0,!0},unlock:function(){return t.enableButton(this.$node.find(".js-toolbar-settings-control")),this._locked=!1,!0},isLocked:function(){return this._locked},save:function(){return this.mToolbarSettings.set().then(function(t){ns.events.trigger("daria:vToolbarSettings:saved",_.pluck(t,"id"))})},_createNewTemplate:function(t){var e=new Vow.Promise,o=new Vow.Promise,n=ns.Model.get("folders").getFidBySymbol("template");return n?o.fulfill():ns.Model.get("folders").createTemplateFolder().then(function(t){n=t.fid,o.fulfill()}),o.then(function(){var o=ns.Model.get("settings"),i=t.match(/^.{1,15}/)||"";i&&(i=i[0],t.length>i.length&&(i+="...")),Daria.SendMail.send({params:{to:"",bcc:"",cc:"",from_mailbox:o.getSetting("default_email"),from_name:o.getSetting("from_name"),go:1,ign_overwrite:"no",nosend:"yes",save_symbol:"template",send:t,subj:i,ttype:"plain",templates_fid:n},success:function(t){if(t.storedmid){["messages","message-nearest","message-thread-nearest","abook-contacts","abook-contact","folders"].forEach(function(t){ns.Model.invalidate(t)}),ns.Model.get("messages-pager",ns.page.current.params).invalidate(),ns.Model.get("messages-pager",{current_folder:n}).invalidate(),ns.page.go(),e.fulfill(t.storedmid)}else e.reject()},error:function(){e.reject()}})}),e}}})}(Jane)},2728:function(t,e,o){!function(){ns.ViewCollection.define("toolbar-buttons",{events:{"ns-view-show":"_onShow","ns-page-after-load":"_onPageAfterLoad","scroll window":"_onScrollWindow","resize window":"_onResizeWindow","daria:vToolbarButton:restruct":"_onRestructToolbarButton","daria:vToolbarSettings:settingsActivated":"_onSettingsActivated","daria:vToolbarSettings:buttonToggled":"_restruct","daria:vToolbarSettings:popupClosed":"_restruct","daria:vToolbarSettings:buttonOptionsChanged":"_restruct","daria:vAbookContacts:selectionChanged":"onAbookSelectionChanged"},models:{settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"onToggleCompactMode","ns-model-changed.liza_minified_header":"onToggleCompactMode"},toolbar:{"ns-model-changed":"keepValid","ns-model-changed.fixed":"onChangeToolbarFixed"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"onMessagesCheckedTouched"}},params:Daria.params.toolbarButtons,split:{byModel:"toolbar",intoViews:function(t){var e="toolbar-button-"+t.get(".id");return ns.View.isDefined(e)||(e=_.contains(e,"abook")?"toolbar-button-abook":"toolbar-button"),e}},ctor:function(){this._lazyRestructToolbar=_.debounce(function(t){this.triggerCheckedCountEvent(),this._restruct(t)},100)},yateModule:"toolbar",methods:{forceRestruct:!1,_onShow:function(){this._lazyRestructToolbar()},onMessagesCheckedTouched:function(){this._lazyRestructToolbar()},_getViews:function(){return _.values(this.views)},getViewsIds:function(t){return _.isUndefined(t)&&(t=this._getViews()),_.map(t,function(t){return t.getId()})},_getViewsToShow:function(){return this._getSpecificViewsHelper("toShow")},_getVisibleViews:function(){return this._getSpecificViewsHelper("isVisible")},_getSpecificViewsHelper:function(t){return _.filter(this._getViews(),function(e){var o=e.getId();if(!_.contains(["more"],o)){var n=e[t];if(n)return n.call(e)}})},onToggleCompactMode:function(){this.keepValid(),_.forEach(this._getViews(),function(t){t.resetButtonWidth()}),this._lazyRestructToolbar()},_restruct:function(t){if(this.isVisible()){var e=!!$.isPlainObject(t)&&t.force,o=this.getModel("toolbar"),n=this.getButtonView("more"),i=this.getButtonView("toolbar-settings");if(n&&(n.show(!0),n.closeExtendButtons()),!(e||this.forceRestruct||o.get(".settings")&&n))return!1;this.forceRestruct=!1;var s=n?n.getWidth():0,a=!!i&&i.toShow(),r=a?i.getWidth():0,l=this.$node.find(".js-toolbar-button-top"),d=l.is(":visible")?l.width():0,c=this.getWidth()-s-r-d,u=0,h=[],b=this._getVisibleViews(),g=this._getViewsToShow();_.reject(b,function(t){return _.contains(g,t)}).forEach(function(t){t.hide(!0)});var f=!1,m=_.filter(g,function(t){if(t.show(!0),a&&"toolbar-settings"===t.getId())return!0;var e=t.getWidth();return n?f||u+e>=c?(f=!0,h.push(t),!1):(u+=e,!0):f||u+e>c?(f=!0,!1):(u+=e,!0)}),p=_.xor(g,m);p=_.uniq(p.concat(this._getSpecificViewsHelper("isMore"))),1===p.length&&u-s+p[0].getWidth()<=c&&(p.shift(),n.hide(!0)),p.forEach(function(t){t.hide(!0)}),n&&(p.length?n.show(!0):n.hide(!0),n.setExtendButtons(p))}},_onSettingsActivated:function(){this.getButton("toolbar-settings").show()},getButtonView:function(t){var e="toolbar-button-"+t;return ns.View.isDefined(e)||(e="toolbar-button"),this.views[ns.View.getKey(e,{id:t})]},getWidth:function(){if(this.getModel("toolbar").isFixed()){var t=this.$node.closest(".js-toolbar-wrap");return t.width()-t.find(".js-toolbar-aside").width()}return this.$node.closest(".js-toolbar-chevron").width()},getButton:function(t){return _.find(this.views,function(e){return e.getId()===t})},_onScrollWindow:_.throttle(function(){var t=this.getButtonView("more");t&&t.closeExtendButtons()},50),_onResizeWindow:function(){this._lazyRestructToolbar()},_onRestructToolbarButton:function(t,e){e&&e.force&&(this.forceRestruct=!0),this._lazyRestructToolbar(e)},onAbookSelectionChanged:function(){this._lazyRestructToolbar({force:!0})},onChangeToolbarFixed:function(){this._lazyRestructToolbar()},triggerCheckedCountEvent:function(){if(this.isVisible()){var t=this.getModel("messages-checked");ns.events.trigger("daria:vToolbarAside:changeCheckedCount",t.getCount())}},_onPageAfterLoad:function(){Daria.is3pane()&&this.getModel("messages-checked").resetMemoizeAndTouch()}}}),o(2729)}()},2729:function(t,e){!function(){var t={};t._restruct=_.debounce(function(){_.forEach(this.views,function(t){t.isSpecial()||t[t.toShow()?"show":"hide"](!0)})},200),ns.ViewCollection.edefine("toolbar-buttons-compose",{models:{settings:!1,toolbar:!1},split:{byModel:"toolbar",intoViews:function(t){var e="toolbar-button-"+t.get(".id");return Daria.is3pane()&&ns.View.isDefined(e+"-3pane")?e+"-3pane":ns.View.isDefined(e)?e:t.get(".special")?"toolbar-button-compose-special":"toolbar-button-compose"}},events:{"ns-page-after-load":"_restruct","compose.mid.change@show":"_restruct"},yateModule:"toolbar",methods:_.extend(t,{_onShow:function(){this.super_._onShow.call(this),this._restruct();var t=Daria.vCompose.type;this.getButton(t).select()},getSpecialButtonIds:function(){return _(this.views).values().map(function(t){return t.isSpecial()?t.getId():null}).compact().value()}}),params:function(){return{layout:ns.page.current.page}}},"toolbar-buttons")}()},2730:function(t,e){!function(){var t=ns.View.infoLite("toolbar-button").methods;ns.View.edefine("toolbar-button-folders-actions",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:function(t){return ns.View.infoLite("toolbar-button").params(t)},events:{"daria:vFoldersActions:open":"onFoldersActionsOpen"},yateModule:"toolbar",methods:{onFoldersActionsOpen:function(){if(this.toShow()){var t=this.$node.parents(".js-toolbar").find(".js-toolbar-item-more"),e=this.isVisible()?this.$node:t;e.length||(e=this.$node.parent()),this.vFoldersActions=ns.View.create("folders-actions"),this.vFoldersActions.open(e,this.getModel("messages-checked"))}},_onClick:function(t,e){this.enabled()&&(e=e||ns.action.getParams(t.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(t,e,"move",this.getCurrentMessageIfSingle()),this.vFoldersActions&&this.vFoldersActions._isOpen||(this.vFoldersActions=ns.View.create("folders-actions"),this.vFoldersActions.open(t.currentTarget,this.getModel("messages-checked"),e)))},toShow:function(){return!!t.toShow.call(this)&&_.contains(["message","messages"],ns.page.current.page)}}},"toolbar-button-disabled","toolbar-button")}()},2731:function(t,e){!function(){ns.View.edefine("toolbar-button-labels-actions",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,events:{"ns-view-show":"onShow","daria:vLabelsActions:open":"onLabelsActionsOpen"},yateModule:"toolbar",methods:{onShow:function(){Daria.isComposePage()&&this.enabled()&&this.toggleEnabled(null,!0)},onLabelsActionsOpen:function(){if(this.toShow()){var t=this.$node.parents(".js-toolbar").find(".js-toolbar-item-more"),e=this.isVisible()?this.$node:t;e.length||(e=this.$node.parent()),this.vLabelsActions=ns.View.create("labels-actions"),this.vLabelsActions.open(e,this.getModel("messages-checked"))}},_onClick:function(t,e){if(this.enabled()){e=e||ns.action.getParams(t.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(t,e,"label",this.getCurrentMessageIfSingle());var o="compose2"===this.params.layout;if(o&&Jane.c("Написание письма","Шапка письма",'Клик в "Метку"'),!this.vLabelsActions||!this.vLabelsActions._isOpen){var n=o?["labels-actions-compose",ns.page.current.params]:["labels-actions",this.params];this.vLabelsActions=ns.View.create.apply(null,n),this.vLabelsActions.open(t.currentTarget,this.getModel("messages-checked"),e)}}},toShow:function(){var t=_.contains(["message","messages","compose2"],ns.page.current.page);return"messages"===ns.page.current.page?t=!ns.Model.get("folders").spamOrTrash(ns.page.current.params.current_folder):"message"===ns.page.current.page&&(t=!ns.Model.get("message",{ids:ns.page.current.params.ids}).inFolderBySymbol(["trash","spam"])),Boolean(t)},enabled:function(){var t=this.getCheckedModel();return t.getCount()||t.isFolderSelected()||Daria.isComposePage()}}},"toolbar-button-disabled","toolbar-button")}()},2732:function(t,e){ns.View.define("mops-confirmation",{models:{"mops-confirmation":{"ns-model-changed":"onMopsConfirmationChanged"},"messages-checked":{"ns-model-changed":"onMessagesCheckedChanged"}},events:{"ns-view-init":"onInit","click .js-confirm-mops":"onConfirm","click .js-cancel-mops":"onCancel"},params:{},yateModule:"toolbar",methods:{onInit:function(){this.onConfirm=this.onConfirm.bind(this),this.onCancel=this.onCancel.bind(this)},clearMops:function(){Daria.Statusline.hide("confirm_mops"),this.getModel("mops-confirmation").setMops({}),this.unbindEvents()},onCancel:function(){this.clearMops(),Jane.c("Нотификации","Функциональные нотификации","confirm_mops","Клик",'Клик в "Отмена"'),Daria.Statusline.hide("confirm_mops")},onConfirm:function(){var t=this.getModel("mops-confirmation").getMops();"function"==typeof t.callback&&t.callback(),this.clearMops();var e={delete:"Удалить",tospam:"Пометить",pin:"Запинить"}[t.action];Jane.c("Нотификации","Функциональные нотификации","confirm_mops","Клик",'Клик в "'+e+'"'),Daria.Statusline.hide("confirm_mops")},onMopsConfirmationChanged:function(){Daria.Statusline.hide("confirm_mops"),this.getModel("mops-confirmation").getMops().action&&(Daria.Statusline.show({name:"confirm_mops",size:"m",isCloseButtonVisible:!1,hideOnTimeout:!1,body:Jane.tt("toolbar:mops-confirmation",this.getViewTexts()),params:this.getViewTexts(),onClose:this.onCancel}),this.bindEvents(),Daria.hasFeature("react-statusline")||$(".js-confirm-mops").focus())},getViewTexts:function(){var t=!ns.Model.get("settings").isThreaded(),e=this.getModel("mops-confirmation").getMops(),o=e.count||0,n={cancelButtonText:i18n("%Отмена"),message:i18n("%Toolbar_MOPS_confirmation_common_message")};return"delete"===e.action&&(n.actionButtonText=i18n("%Toolbar_Удалить"),n.title=i18n("%N_Toolbar_MOPS_confirmation_remove",o),t&&(n.message=i18n("%Toolbar_MOPS_confirmation_remove_message_no_threads"))),"tospam"===e.action&&(n.actionButtonText=i18n("%Toolbar_Пометить"),n.title=i18n("%N_Toolbar_MOPS_confirmation_mark_as_spam",o),t&&(n.message=i18n("%Toolbar_MOPS_confirmation_mark_as_spam_message_no_threads"))),"pin"===e.action&&(n.actionButtonText=i18n("%Pinned_Запинить_письмо"),n.title=i18n("%N_Toolbar_MOPS_confirmation_pin",o),n.message=i18n("%Toolbar_MOPS_confirmation_pin_message")),n},bindEvents:function(){Daria.hasFeature("react-statusline")?($("body").on("click",".js-confirm-mops",this.onConfirm),$("body").on("click",".js-cancel-mops",this.onCancel)):($(".js-confirm-mops").on("click",this.onConfirm),$(".js-cancel-mops").on("click",this.onCancel))},unbindEvents:function(){Daria.hasFeature("react-statusline")?($("body").off("click",".js-confirm-mops",this.onConfirm),$("body").off("click",".js-cancel-mops",this.onCancel)):($(".js-confirm-mops").off("click",this.onConfirm),$(".js-cancel-mops").off("click",this.onCancel))},onMessagesCheckedChanged:function(){var t=this.getModel("mops-confirmation").getMops();0===this.getModel("messages-checked").getCount()&&t.action&&this.clearMops()}}})},2733:function(t,e){var o=ns.Model.get("all-toolbar-buttons"),n={scroll:!0,settings:!0},i=Daria.Constants.TOOLBAR_BUTTONS,s={messages:[i.MAIN_SELECT_ALL,i.MAIN_DESELECT_ALL,i.COMPOSE_GO,i.CHECK_MAIL,i.FORWARD,i.DELETE,i.ADD_TEMPLATE,i.SPAM,i.NOT_SPAM,i.MARK_AS_READ,i.PIN,i.UNPIN,i.MARK_AS_UNREAD,i.ARCHIVE,i.SENDON,i.INFOLDER,i.LABEL,i.TEMPLATE,i.LABELS_ACTIONS,i.FOLDERS_ACTIONS,i.MORE,i.TOOLBAR_SETTINGS],message:[i.COMPOSE_GO,i.CHECK_MAIL,i.EDIT,i.REPLY,i.REPLY_ALL,i.FORWARD,i.DELETE,i.SPAM,i.NOT_SPAM,i.UNSUBSCRIBE,i.MARK_AS_UNREAD,i.PIN,i.UNPIN,i.ARCHIVE,i.SENDON,i.INFOLDER,i.LABEL,i.TEMPLATE,i.LABELS_ACTIONS,i.FOLDERS_ACTIONS,i.TRANSLATE,i.PRINT,i.FILTERS_CREATE,i.MESSAGE_SOURCE,i.MORE,i.TOOLBAR_SETTINGS],"no-message":[i.COMPOSE_GO,i.CHECK_MAIL,i.FORWARD,i.DELETE,i.SPAM,i.NOT_SPAM,i.MARK_AS_UNREAD]};_.each(s,function(t,e){var i=o.getButtonsByIds(t);ns.Model.get("toolbar",{layout:e}).setData(_.extend({},n,{buttons:i}))})}});